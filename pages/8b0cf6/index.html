<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>FreeSWITCH学习 | 董建斌的博客</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/home.jpeg">
    <script data-ad-client="ca-pub-7828333725993554" async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="web前端技术博客,简洁至上,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.b0cf3990.css" as="style"><link rel="preload" href="/assets/js/app.6d4d842b.js" as="script"><link rel="preload" href="/assets/js/2.0fd9f73a.js" as="script"><link rel="preload" href="/assets/js/15.fbc57fc3.js" as="script"><link rel="prefetch" href="/assets/js/10.30079daa.js"><link rel="prefetch" href="/assets/js/11.7f6a0939.js"><link rel="prefetch" href="/assets/js/12.ed5435d3.js"><link rel="prefetch" href="/assets/js/13.25b8826c.js"><link rel="prefetch" href="/assets/js/14.76f97bc8.js"><link rel="prefetch" href="/assets/js/16.00f2abfa.js"><link rel="prefetch" href="/assets/js/17.bc136f60.js"><link rel="prefetch" href="/assets/js/18.4d03df41.js"><link rel="prefetch" href="/assets/js/19.479cc21a.js"><link rel="prefetch" href="/assets/js/20.7e179576.js"><link rel="prefetch" href="/assets/js/21.240900bb.js"><link rel="prefetch" href="/assets/js/22.760ddcdd.js"><link rel="prefetch" href="/assets/js/23.0eab3370.js"><link rel="prefetch" href="/assets/js/24.588b162f.js"><link rel="prefetch" href="/assets/js/25.1c0ee689.js"><link rel="prefetch" href="/assets/js/26.85709468.js"><link rel="prefetch" href="/assets/js/27.b7099b40.js"><link rel="prefetch" href="/assets/js/28.c35924d3.js"><link rel="prefetch" href="/assets/js/29.8cafffa8.js"><link rel="prefetch" href="/assets/js/3.deaca20e.js"><link rel="prefetch" href="/assets/js/30.575b6478.js"><link rel="prefetch" href="/assets/js/31.e17b3314.js"><link rel="prefetch" href="/assets/js/32.05421eeb.js"><link rel="prefetch" href="/assets/js/33.d17be6c8.js"><link rel="prefetch" href="/assets/js/34.bdacecf3.js"><link rel="prefetch" href="/assets/js/35.2cdfbdfe.js"><link rel="prefetch" href="/assets/js/4.c0dbb0eb.js"><link rel="prefetch" href="/assets/js/5.41b1224c.js"><link rel="prefetch" href="/assets/js/6.e5641358.js"><link rel="prefetch" href="/assets/js/7.f95c6863.js"><link rel="prefetch" href="/assets/js/8.079a2b3f.js"><link rel="prefetch" href="/assets/js/9.34e7a5b8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b0cf3990.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/img/home.jpeg" alt="董建斌的博客" class="logo"> <span class="site-name can-hide">董建斌的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="FreeSwitch" class="dropdown-title"><a href="/web/" class="link-title">FreeSwitch</a> <span class="title" style="display:none;">FreeSwitch</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>安装使用</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/a61298/" class="nav-link">FS安装使用</a></li></ul></li><li class="dropdown-item"><h4>呼叫中心</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/c3da99/" class="nav-link">项目架构</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="知识图谱" class="dropdown-title"><a href="/KnowledgeGraph/" class="link-title">知识图谱</a> <span class="title" style="display:none;">知识图谱</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/ec61c3/" class="nav-link">neo4j</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目" class="dropdown-title"><a href="/project/" class="link-title">项目</a> <span class="title" style="display:none;">项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3ceacd/" class="nav-link">超级工作流</a></li><li class="dropdown-item"><!----> <a href="/pages/601d2d/" class="nav-link">kafka2db</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><a href="/pages/2c361a/" class="link-title">大数据</a> <span class="title" style="display:none;">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/81241e/" class="nav-link">hadoop入门</a></li></ul></div></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/dong-jianbin/docment" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/img/22168884.jpeg"> <div class="blogger-info"><h3>董建斌</h3> <span>此间少年 气吞山河</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="FreeSwitch" class="dropdown-title"><a href="/web/" class="link-title">FreeSwitch</a> <span class="title" style="display:none;">FreeSwitch</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>安装使用</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/a61298/" class="nav-link">FS安装使用</a></li></ul></li><li class="dropdown-item"><h4>呼叫中心</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/c3da99/" class="nav-link">项目架构</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="知识图谱" class="dropdown-title"><a href="/KnowledgeGraph/" class="link-title">知识图谱</a> <span class="title" style="display:none;">知识图谱</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/ec61c3/" class="nav-link">neo4j</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目" class="dropdown-title"><a href="/project/" class="link-title">项目</a> <span class="title" style="display:none;">项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3ceacd/" class="nav-link">超级工作流</a></li><li class="dropdown-item"><!----> <a href="/pages/601d2d/" class="nav-link">kafka2db</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><a href="/pages/2c361a/" class="link-title">大数据</a> <span class="title" style="display:none;">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/81241e/" class="nav-link">hadoop入门</a></li></ul></div></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/dong-jianbin/docment" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>服务端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>呼叫中心</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/8b0cf6/" aria-current="page" class="active sidebar-link">FreeSWITCH学习</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/8b0cf6/#pstn与voip基础" class="sidebar-link">PSTN与VoIP基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#pstn起源与发展" class="sidebar-link">PSTN起源与发展</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#电话实现技术" class="sidebar-link">电话实现技术</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#我国电话网结构" class="sidebar-link">我国电话网结构</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#信令" class="sidebar-link">信令</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#媒体" class="sidebar-link">媒体</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#电路交换与分组交换" class="sidebar-link">电路交换与分组交换</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#voip" class="sidebar-link">VoIP</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#ims" class="sidebar-link">IMS</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/8b0cf6/#pstn、pbx及呼叫中心业务" class="sidebar-link">PSTN、PBX及呼叫中心业务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#pstn业务" class="sidebar-link">PSTN业务</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#pbx业务" class="sidebar-link">PBX业务</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#ip-pbx业务" class="sidebar-link">IP-PBX业务</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#呼叫中心" class="sidebar-link">呼叫中心</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/8b0cf6/#初识freeswitch" class="sidebar-link">初识FreeSWITCH</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#什么是freeswitch" class="sidebar-link">什么是FreeSWITCH</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#快速体验" class="sidebar-link">快速体验</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/8b0cf6/#运行freeswitch" class="sidebar-link">运行FreeSWITCH</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#命令行参数" class="sidebar-link">命令行参数</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#系统启动脚本" class="sidebar-link">系统启动脚本</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#判断freeswitch是否运行" class="sidebar-link">判断FreeSWITCH是否运行</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#控制台与命令客户端" class="sidebar-link">控制台与命令客户端</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#呼叫" class="sidebar-link">呼叫</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/8b0cf6/#freeswitch架构" class="sidebar-link">FreeSWITCH架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#总体架构" class="sidebar-link">总体架构</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#目录结构" class="sidebar-link">目录结构</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#配置文件" class="sidebar-link">配置文件</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#xml用户目录" class="sidebar-link">XML用户目录</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#呼叫相关概念" class="sidebar-link">呼叫相关概念</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/8b0cf6/#拨号计划" class="sidebar-link">拨号计划</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#简单测试" class="sidebar-link">简单测试</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#xmldialplan" class="sidebar-link">XMLDialplan</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#inline-dialplan" class="sidebar-link">inline Dialplan</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#其他dialplan" class="sidebar-link">其他Dialplan</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#常用的dialplan-app" class="sidebar-link">常用的Dialplan App</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#在dialplan中使用api命令" class="sidebar-link">在Dialplan中使用API命令</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#深入理解通道变量以及相关操作" class="sidebar-link">深入理解通道变量以及相关操作</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/8b0cf6/#sip协议" class="sidebar-link">SIP协议</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#sip协议基础" class="sidebar-link">SIP协议基础</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#sip注册" class="sidebar-link">SIP注册</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#sip呼叫流程" class="sidebar-link">SIP呼叫流程</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#深入理解sip" class="sidebar-link">深入理解SIP</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/8b0cf6/#媒体-2" class="sidebar-link">媒体</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#媒体与媒体处理" class="sidebar-link">媒体与媒体处理</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#媒体协商" class="sidebar-link">媒体协商</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#其他媒体相关的问题" class="sidebar-link">其他媒体相关的问题</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/8b0cf6/#sip模块" class="sidebar-link">SIP模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#基本概念" class="sidebar-link">基本概念</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#sofia配置文件" class="sidebar-link">Sofia配置文件</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#常用命令" class="sidebar-link">常用命令</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#nat穿越" class="sidebar-link">NAT穿越</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/8b0cf6/#基本技能" class="sidebar-link">基本技能</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#调试与排错" class="sidebar-link">调试与排错</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#使用外部工具包" class="sidebar-link">使用外部工具包</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#使用wireshark抓包并分析呼叫" class="sidebar-link">使用Wireshark抓包并分析呼叫</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#originate命令实例解析" class="sidebar-link">originate命令实例解析</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#呼叫是怎样工作的" class="sidebar-link">呼叫是怎样工作的</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#freeswitch图形用户界面简介" class="sidebar-link">FreeSWITCH图形用户界面简介</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/8b0cf6/#基本功能与实现" class="sidebar-link">基本功能与实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#批量创建用户" class="sidebar-link">批量创建用户</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#用freeswitch实现ivr" class="sidebar-link">用FreeSWITCH实现IVR</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#按时间进行路由" class="sidebar-link">按时间进行路由</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#配置中文语音提示" class="sidebar-link">配置中文语音提示</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#录音" class="sidebar-link">录音</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#放音" class="sidebar-link">放音</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#tts" class="sidebar-link">TTS</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#在呼叫失败的情况下向主叫用户播放语音提示" class="sidebar-link">在呼叫失败的情况下向主叫用户播放语音提示</a></li><li class="sidebar-sub-header level3"><a href="/pages/8b0cf6/#实现呼叫前转业务" class="sidebar-link">实现呼叫前转业务</a></li></ul></li></ul></li><li><a href="/pages/c3da99/" class="sidebar-link">项目架构</a></li></ul></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/web/#freeswitch" data-v-06225672>freeswitch</a></li><li data-v-06225672><a href="/web/#呼叫中心" data-v-06225672>呼叫中心</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/dong-jianbin/" target="_blank" title="作者" class="beLink" data-v-06225672>dong-jianbin</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-02-28</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">FreeSWITCH学习<!----></h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
     <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:90px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="theme-vdoing-content content__default"><h2 id="pstn与voip基础"><a href="#pstn与voip基础" class="header-anchor">#</a> PSTN与VoIP基础</h2> <ul><li>VoIP（Voice Over IP）：承载于IP网上的语音通信（网络电话）。</li> <li>PSTN（Public Switched Telephone Network）：公共交换电话网。</li></ul> <h3 id="pstn起源与发展"><a href="#pstn起源与发展" class="header-anchor">#</a> PSTN起源与发展</h3> <blockquote><p>在漫长的通信历史长河中，PSTN以及电话交换技术的发展经历了很多阶段，如从直接控
制到间接控制再到公共控制、从人工交换到自动交换、从点子交换到程控交换、从模拟到
数字、从电路交换到分组交换、从“硬”交换到软交换。</p></blockquote> <h4 id="最早的电话网"><a href="#最早的电话网" class="header-anchor">#</a> 最早的电话网</h4> <p>第一次语音传输是苏格兰人亚历山大·贝尔（Alexander Granham Bell）在1876年用振铃电
路实现的。</p> <p>振铃电路实现是没有电话号码的，通话用户之间必须由物理线路连接，同一时间只能一个
用户讲话。</p> <h4 id="人工电话交换时代"><a href="#人工电话交换时代" class="header-anchor">#</a> 人工电话交换时代</h4> <p>交换机（<a href="https://so.csdn.net/so/search?q=Switch&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreferrer">Switch<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，又称Exchange）的设备诞生了，线路大大减小。交换连续工作全部由人工
完成。</p> <h4 id="自动电话交换时代"><a href="#自动电话交换时代" class="header-anchor">#</a> 自动电话交换时代</h4> <p>1889年到1891年期间，美国阿尔蒙·B·史端桥（Almon B Strowger）发明了步进式自动电话交
换机。属于“直接控制”方式。</p> <p>以后，又出现了旋转式和升降式的交换机。采用“记发器”的部件来接收用户的拨号脉冲，属于
“间接控制”方式。</p> <p>1919年，瑞典的电话工程师帕尔姆格伦和贝塔兰德发明了“纵横制连接器”。把控制器和话路器
分开。控制部分由标志器和记发器来完成。</p> <h4 id="半电子交换机时代"><a href="#半电子交换机时代" class="header-anchor">#</a> 半电子交换机时代</h4> <p>控制部分引入了电子技术，而话路部分在较长的一段时间内仍采用机械触电。</p> <h4 id="空分交换机时代"><a href="#空分交换机时代" class="header-anchor">#</a> 空分交换机时代</h4> <p>1965年5月，美国布尔系统的1号电子交换机（ESS No.1）问世了，这是世界上第一部开通使用
的程控电话交换机。当时的交换机话路部分还保留了机械触电，以“空分”方式工作，因此称为
空分交换机。交换的还是模拟信号。</p> <h4 id="数字交换时代"><a href="#数字交换时代" class="header-anchor">#</a> 数字交换时代</h4> <p>20世纪60年代初以来，脉冲编码调制（PCM）技术成功地应用于传输系统中，它将“模拟”的信号
数字化，提高了通话质量、增加了传输距离，节约了许多线路成本。1970年，法国开通了世界上
第一部程控数字交换机E10，开始了数字交换的心时代。</p> <h4 id="现代pstn时代"><a href="#现代pstn时代" class="header-anchor">#</a> 现代PSTN时代</h4> <p>随着技术的进步和通信要求的增加，世界上许许多多的交换机也需要相互通信，这些交换机之间
通过中继线（Trunk）相连，随着电子交换机和程控交换机的发展，便出现了现代意义的PSTN网
络。</p> <p>20世纪70年代后期出现了蜂窝式移动电话（当移动电话小到可以拿到手里的时候就开始叫“手机”了
）系统，这是无线电话发展的里程碑。无限电话的出现，扩展了PSTN网络能力和范围，对PSTN网络
的影响及其深远。</p> <p>专门用于移动电话交换的通信网络称为移动网，而原来的程控交换网则称为固定电话网，简称固网。
简单来说，移动网就是在普通固网上增加了许多基站（Base Station，可以简单理解为天线），并
增加了归属位置寄存器（Home Location Register，HLR）和拜访位置寄存器（Visitor Location
Register，VLR），以记录用户的位置（）、支持异地漫游等。移动交换中心称为MSC（Mobile Switch
Center）。</p> <h4 id="下一代网络及voip时代"><a href="#下一代网络及voip时代" class="header-anchor">#</a> 下一代网络及VoIP时代</h4> <p>随着分组交换的成熟及英特网的发展，人们认识到了将原始的基于电路交换的语音网络与基于分组
交换的英特网络进行融合（即语音通信和数据通信相结合）的必要性，因此一个称为NGN（Next
Generation Network）的概念被提了出来。</p> <p>经过数年的研究和探索，人们提出了各种NGN解决方案，但最终基本上都统一到了IMS（IP Multimedia
Subsystem）技术。</p> <p>IMS属于核心交换层的技术，它全部基于IP网络，但在接入层，目前的语音大部分还是基于电路接入
的方式接入的，因此，在一定时间内IMS在接入层要继续兼容电路接入。未来的通信中要求完全取消
低效的电路传输及电路交换，而全部集中在IP通信上来，也就催生了新的无限通信标准LTE。</p> <p>关于通信网络的演进，简单来说，在无线方面体现为从GSM/CDMA/UMTS等向LTE发展，在核心网方面则
体现为电路交换向IMS发展。</p> <h3 id="电话实现技术"><a href="#电话实现技术" class="header-anchor">#</a> 电话实现技术</h3> <h4 id="电话号码"><a href="#电话号码" class="header-anchor">#</a> 电话号码</h4> <ol><li><p>固定电话号码</p> <p>现行的电话网中采用E.164号码格式。</p></li> <li><p>移动电话号码和专用号段</p> <p>移动电话号码俗称手机号，由于其可移动与漫游的特性，与普通固定电话略有不同。我国的移动电话
都是以1开头，按不同的运营商来划分。</p></li> <li><p>短号码</p> <p>有一类特殊的号码称为短号码，如110,119,120等。</p></li> <li><p>800和400号码</p> <p>800号码用手机打不通，400是可以手机呼叫的。</p></li> <li><p>北美电话号码分类计划</p> <p>加拿大和美国使用北美电话号码分类计划，其区号由3位数字组成，本地号码为7位数字，1为长途接入
码，即长途字冠。</p></li> <li><p>电话号码书写格式</p> <p>国内号码的书写一般采用如下的方式：</p> <ul><li>(010)ABCD EFGH （没有国家代码，虽然0不是区号的一部分，但是，习惯了）</li> <li>+86（10）ABCD EFGH （固话，8位，国际号码格式）</li> <li>+86（10）ABCD EFGH （固话，8位，国际号码格式）</li> <li>+86 139 ABCD EFGH （手机，国际号码格式）</li></ul></li></ol> <h4 id="模拟信号与数字信号"><a href="#模拟信号与数字信号" class="header-anchor">#</a> 模拟信号与数字信号</h4> <p>模拟（Analog）量是连续的变化的量。容易引入噪音。</p> <p>数字（Digital）信号是不连续的（离散的）。</p> <h4 id="pcm"><a href="#pcm" class="header-anchor">#</a> PCM</h4> <p>PCM（Pulse Code Modulation）的全称是脉冲编码调制。它是一种通用的将模拟信号转换成以0和1表示
的数字信号的方法。</p> <p>人的音频范围在300~3400Hz之间，通过滤波器将超过4000Hz的频率过滤出去，便得到4000Hz内的模拟信
号。然后根据抽样定理，使用8000Hz进行抽样，便得到离散的数字信号。使用PCM方法得到的数字信号
就称为PCM信号，一般一次抽样会得到16bit的信息。</p> <p>使用压缩算法，可以将每一个抽样值压缩到8bit。这样1秒的抽样就得到8bit×8000=640000bit信号（简称
64kbit），抽样速率（即传输速率）为64Kbit/s。</p> <p>PCM通常有两种压缩方式：A律和μ率。北美使用μ律，我国和欧洲使用A率。</p> <h4 id="局间中继与电路复用技术"><a href="#局间中继与电路复用技术" class="header-anchor">#</a> 局间中继与电路复用技术</h4> <p>连接交换机（局）的E1或T1电路称为局间中继。</p> <h3 id="我国电话网结构"><a href="#我国电话网结构" class="header-anchor">#</a> 我国电话网结构</h3> <p>我国电话网由本地网与长途网组成，并通过国际交换中心进入国际电话网。</p> <h3 id="信令"><a href="#信令" class="header-anchor">#</a> 信令</h3> <p>用户设备（如话机）与端局交换机之间，以及交换机与交换机之间需要进行通信。这些通信所包含的信息有
（但不限于）用户、中继线状态、主叫号码、被叫号码、中继路由的选择等。我们把这些消息称为
信令（Signaling）。</p> <h4 id="信令分类"><a href="#信令分类" class="header-anchor">#</a> 信令分类</h4> <p>按信令的功能分</p> <ul><li>线路信令：具有监视功能，用来监视主被叫的摘、挂机状态及设备忙闲。</li> <li>路由信令：具有选择功能，指主叫所拨的被叫号码，用来选择路由</li> <li>管理信令：具有操作功能，用于电话网的管理和维护。</li></ul> <p>按信令的工作区域分</p> <ul><li>用户线信令：是用户终端与交换机之间的信令。</li> <li>局间信令：是交换机和交换机之间的信号，在局间中继线上传送，用来控制呼叫连续和拆线。</li></ul> <p>按信令的信道分</p> <ul><li>随路信令：信令和话音在同一条话路中传输。</li> <li>公共信道信令：以时分方式在一条高速数据链路上传送一群话路。</li></ul> <p>其他分类</p> <p>信令还可以分为带内信令和带外信令、模拟信令和数字信令、向前信令和向后信令、线路信令和记发器信令等。</p> <h4 id="用户线信令"><a href="#用户线信令" class="header-anchor">#</a> 用户线信令</h4> <p>从用户终端（通常是话机）到端局交换机之间经常需要传送一些控制信息，如用户摘机、挂机、拨号、主叫号码
显示等，这些信息称为用户线信令。用户线信令可以通过模拟或数字信号传递。</p> <h4 id="局间信令"><a href="#局间信令" class="header-anchor">#</a> 局间信令</h4> <p>交换机与交换机之间也需要传送控制信号，用于话路的建立、释放等，这些信号就称为局间信令。</p> <p>目前在传统的PSTN网络中常见的局间信号有ISDN PRI（Primary Rate Interface，基群速率接口）信令和七号信令。
PRI信令和话路在同一个E1上传送。七号信令可以与话路在同一个E1上传送外，还可以在专门的用于传送信令链路的E1中继上传送。</p> <h4 id="七号信令"><a href="#七号信令" class="header-anchor">#</a> 七号信令</h4> <p>七号信令（Signaling System No.7，SS7）是我国目前使用的主要信令方式，用于局间通信。我国的电话网络中有专
门的七号信令网。</p> <p>由于ISUP（ISDN User Part，ISDN用户部分）能与ISDN互联并提供比TUP更多的能力和服务，故其已基本取代TUP成为我国七号信令网采用的主要信令方式。</p> <h4 id="h-323与sip信令"><a href="#h-323与sip信令" class="header-anchor">#</a> H.323与SIP信令</h4> <p>H.323与SIP属于VoIP领域的通信信令，它们适用于用户线信令和局间信令。</p> <p>H.323是ITU多媒体通信系列标准H.32x的一部分，该系列标准使得在现有通信网络上进行视频会议称为可能。</p> <p>SIP（Session Initiation Protocol，会话发起协议）是由IETF（Interne 工程任务组）提出的IP电话信令协议。</p> <h3 id="媒体"><a href="#媒体" class="header-anchor">#</a> 媒体</h3> <p>信令主要传输一些控制信号，而通信双方需要听到的是对方的语音数据，这些语音数据就称为媒体（Media）.</p> <p>在SIP通信中，除文字外，媒体都是在RTP协议中传输的。由于媒体一般都是持续传输的，因此又称RTP流。</p> <h3 id="电路交换与分组交换"><a href="#电路交换与分组交换" class="header-anchor">#</a> 电路交换与分组交换</h3> <p>传统电路交换，两个通信节点间需要建立一个专用通路。而报文交换以报文作为数据交换单位，携带目标地址、源地址等信息。分组交换是报文交换的特殊情形。</p> <h4 id="电路交换"><a href="#电路交换" class="header-anchor">#</a> 电路交换</h4> <p>传统的电话都是基于电路交换的。</p> <p>电路交换的优点：</p> <ul><li>由于通信线路为通信双方用户专用，数据直达，所以传输数据的时延性非常小。</li> <li>通信双方之间的物理通路一旦建立，双方可以随时通信，实时性强。</li> <li>双方通信时按发送顺序传输数据，不存在失序问题</li> <li>电路交换既适用于传输模拟信号，又适用于传输数字信号。</li> <li>进电路交换的设备（交换机等）及控制均较简单</li></ul> <p>电路交换的缺点：</p> <ul><li>电路交换的平均连接建立时间对计算机通信来说较长。</li> <li>建立电路交换连接后，物理通路被通信双方独占，即使通信线路空闲，也不能供其他用户使用，因而通信利用率低。</li> <li>在进行电路交换时，数据直达，不同类型、不同规格、不同速率的终端很难相互进行通信，也难在通信过程中进行差错控制。</li></ul> <h4 id="分组交换"><a href="#分组交换" class="header-anchor">#</a> 分组交换</h4> <p>IP交换采用的就是分组交换方式。</p> <p>分组交换的优点：</p> <ul><li>加快了数据在网络中的传输速度。</li> <li>简化了存储管理。</li> <li>减少了重发几率和重发数据量。</li> <li>由于分组短小，更适用于采用优先级策略。</li></ul> <p>分组交换的缺点：</p> <ul><li>尽管分组交换比报文交换的传输时延少，但仍存在存储转发时延，而且节点交换机必须有更强的处理能力。</li> <li>分组交换都要加上源、目的地址和分组编号，一定程度降低了通信效率，增加了处理时间，使控制复杂、
时延增加。</li> <li>分组到达目的节点时，要对分组按编号进行排序等工作，增加了麻烦。</li></ul> <h3 id="voip"><a href="#voip" class="header-anchor">#</a> VoIP</h3> <p>IP电话（Voice over Internet Protocol，VoIP，又称宽带电话或网络电话）是一种透过互联网或其他使用
IP技术的网络来实现的新型电话通信。</p> <p>目前，VoIP呼叫控制协议主要有SIP、H.323、MGCP与H.248/MEGACO等。</p> <h3 id="ims"><a href="#ims" class="header-anchor">#</a> IMS</h3> <h4 id="什么是ims"><a href="#什么是ims" class="header-anchor">#</a> 什么是IMS</h4> <p>IMS的全称是IP多媒体子系统（IP Multimedia Subsystem），它是一个基于IP网提供语音及多媒体的网络体系
架构。</p> <h4 id="ims的特点"><a href="#ims的特点" class="header-anchor">#</a> IMS的特点</h4> <ul><li>采用SIP作为呼叫控制协议。</li> <li>支持Diameter协议。</li> <li>采用归属控制方式。</li> <li>采用接入无关性。</li> <li>业务、控制、承载层完全分离。</li> <li>增强计费功能。</li> <li>增强多媒体业务。</li></ul> <h4 id="ims核心网元"><a href="#ims核心网元" class="header-anchor">#</a> IMS核心网元</h4> <ol><li><p><strong>CSCF</strong></p> <p>CSCF（Call Sessoin Control Function，呼叫会话控制功能）。</p> <ul><li>代理CSCF（P-CSCF）</li> <li>问询CSCF（I-CSCF）</li> <li>服务CSCF（S-CSCF）</li></ul></li> <li><p><strong>MGCF</strong></p> <p>MGCF（Media Gateway Control Function，媒体网关控制功能）</p> <ul><li>控制IMS-MGW中的媒体信道的连接。</li> <li>与CSCF通信。</li> <li>根据路由号码，为从传统网络来的入局呼叫选择CSCF。</li> <li>执行ISUP协议和IMS呼叫控制协议间的转换。</li></ul></li> <li><p><strong>IM-MGW</strong></p> <p>IM-MGW（IP Multimedia-Media Gateway Function，多媒体网关功能）</p> <ul><li>通过与MGCF交互来进行资源控制。</li> <li>拥有并维护回声消除器等资源。</li> <li>可能需要多媒体数字信号编、解码器。</li></ul></li> <li><p><strong>MRF</strong></p> <p>MRF（Multimedia Resource Function，多媒体资源功能）分成两部分，包括MRFC（Multimedia Resource Function Controller，多媒体资源功能控制器）和MRFP（Multimedia Resource Function Processor，多媒体资源功能处理器）。</p></li> <li><p><strong>SLF</strong></p> <p>SLF（Subscription Locator Function，签约定位功能）</p></li> <li><p><strong>HSS</strong></p> <p>HSS（Home Subscriber Server，归属用户服务功能）</p></li> <li><p><strong>BGCF</strong></p> <p>BGCF（Breakout Gateway Control Function，出口网关控制功能）</p></li> <li><p><strong>SGW</strong></p> <p>SGW（Singnalling Gateway Function，信令网关功能）</p></li> <li><p><strong>AS</strong></p> <p>AS（Application Server，应用服务器）</p></li></ol> <h2 id="pstn、pbx及呼叫中心业务"><a href="#pstn、pbx及呼叫中心业务" class="header-anchor">#</a> PSTN、PBX及呼叫中心业务</h2> <h3 id="pstn业务"><a href="#pstn业务" class="header-anchor">#</a> PSTN业务</h3> <p>PSTN除了为用户提供基本的语音通话外，还能提供一些附加的业务，如叫醒业务、呼叫转移等。</p> <h4 id="pots"><a href="#pots" class="header-anchor">#</a> POTS</h4> <p>POTS（Plain Old Telephone Service）及普通老式电话业务。</p> <h4 id="商务业务"><a href="#商务业务" class="header-anchor">#</a> 商务业务</h4> <ul><li><strong>模拟中继线</strong></li> <li><strong>数字中继线</strong></li> <li><strong>虚拟网</strong></li> <li><strong>立即计费</strong></li> <li><strong>VPN</strong></li></ul> <h4 id="其他增值业务"><a href="#其他增值业务" class="header-anchor">#</a> 其他增值业务</h4> <p>包括预付费业务（电话卡类业务等）、800业务、400业务以及彩铃、电话秘书台等。</p> <h3 id="pbx业务"><a href="#pbx业务" class="header-anchor">#</a> PBX业务</h3> <p>PBX（Private Branch eXchange）的全称是专用小交换机。</p> <h4 id="呼叫转移"><a href="#呼叫转移" class="header-anchor">#</a> 呼叫转移</h4> <h4 id="同组代答"><a href="#同组代答" class="header-anchor">#</a> 同组代答</h4> <h4 id="pbx与中继线"><a href="#pbx与中继线" class="header-anchor">#</a> PBX与中继线</h4> <p>用户或企业PBX要想打通外面的电话，或者外面的电话需要打进来，需要走运营商提供的中继线，
以接入到PSTN网上。</p> <h3 id="ip-pbx业务"><a href="#ip-pbx业务" class="header-anchor">#</a> IP-PBX业务</h3> <p>FreeSWITCH的默认配置就是一个家用或小型企业级PBX，它是由纯软件实现的，基于IP网进行通信，
因而又称为IP-PBX。</p> <p>IP-PBX首先是一个PBX（Private Branch eXchange），它具有传统PBX的绝大部分功能。另外，由于
使用了IP通信，它能够通过IP网提供语音、视频以及即时消息通信。</p> <h3 id="呼叫中心"><a href="#呼叫中心" class="header-anchor">#</a> 呼叫中心</h3> <p>基于企业级的PBX和IP-PBX的通信还只是局限于基础的通信层。而随着企业规模的扩大以及用户对服务
要求的提高，企业需要在业务层和管理层方面为用户提供更好的服务。当这些服务可以通过远程电话
支持的方式解决的情况下，一种称为呼叫中心的业务（Call Center）便产生了。</p> <h4 id="什么是呼叫中心"><a href="#什么是呼叫中心" class="header-anchor">#</a> 什么是呼叫中心</h4> <p>呼叫中心又称客户服务中心，它是一种基于CTI技术、充分利用通信网和计算机网的多项功能集成，并
与企业连为一体的一个完整的综合信息服务系统，利用现有的各种先进的通信手段，高效的为客户提供
高质量、高效率、全方位的服务。</p> <p>通俗的将，呼叫中心是企业或机构建立的以电话为主的主要手段，为客户提供服务于沟通的部门组织及
信息系统。</p> <h4 id="呼叫中心的历史"><a href="#呼叫中心的历史" class="header-anchor">#</a> 呼叫中心的历史</h4> <ol><li><p><strong>第一代呼叫中心</strong></p> <p>PBX基础上增加电话排队。</p></li> <li><p><strong>第二代呼叫中心</strong></p> <p>IVR（Interactive Voice Response，交互式语音应答）系统的使用。</p></li> <li><p><strong>第三代呼叫中心</strong></p> <p>CTI（Computor Telephony Integration，计算机电话集成）技术的应用。</p></li> <li><p><strong>第四代呼叫中心</strong></p> <p>多媒体呼叫中心或联络中心（Contact Center）。</p></li> <li><p><strong>下一代呼叫中心</strong></p> <p>融入互联网技术的媒体渠道与沟通渠道。</p></li></ol> <h4 id="呼叫中心的分类"><a href="#呼叫中心的分类" class="header-anchor">#</a> 呼叫中心的分类</h4> <p>按照呼叫中心系统采用的技术架构的不同，呼叫中心可以分为交换机、板卡、软交换（IPCC）三种类型。</p> <h4 id="呼叫中心的主要技术指标"><a href="#呼叫中心的主要技术指标" class="header-anchor">#</a> 呼叫中心的主要技术指标</h4> <p>常见的KPI指标有接通率、呼入项目占有率、呼出项目工作效率、服务水品、客户满意度、平均振铃次数、
监听合格率、一次性解决问题率等。</p> <h4 id="cti中间件"><a href="#cti中间件" class="header-anchor">#</a> CTI中间件</h4> <p>交换机设备厂商开始考虑为交换机增加一个可以受计算机系统控制的接口，有计算机系统通过某种协议
获取交换机用户话机的状态信息以及对呼叫的控制命令。这种连接和控制接口称为CTI-Link。</p> <p>CTI中间件在下层通过对各种CTI-Link协议的包装和抽象，屏蔽了各种交换机的不同，在上层为呼叫中心
业务软件开发人员提供统一的API开发接口。</p> <h4 id="freeswitch在呼叫中心的应用"><a href="#freeswitch在呼叫中心的应用" class="header-anchor">#</a> FreeSWITCH在呼叫中心的应用</h4> <ul><li><strong>语音交换功能</strong></li> <li><strong>媒体处理功能</strong></li> <li><strong>媒体监播功能</strong></li> <li><strong>电话会议功能</strong></li> <li><strong>电子传真功能</strong></li> <li><strong>排队功能</strong></li></ul> <h2 id="初识freeswitch"><a href="#初识freeswitch" class="header-anchor">#</a> 初识FreeSWITCH</h2> <h3 id="什么是freeswitch"><a href="#什么是freeswitch" class="header-anchor">#</a> 什么是FreeSWITCH</h3> <h4 id="freeswitch的概念"><a href="#freeswitch的概念" class="header-anchor">#</a> FreeSWITCH的概念</h4> <p>FreeSWITCH是一个开源的电话交换平台。官方给它的定义是–世界上第一个跨平台的、伸缩性极好的、免费
的、多协议的电话软交换平台。</p> <h4 id="freeswitch的功能"><a href="#freeswitch的功能" class="header-anchor">#</a> FreeSWITCH的功能</h4> <p>典型功能：</p> <ul><li>在线计费、预付费功能</li> <li>电话路由服务器</li> <li>语音转码服务器</li> <li>支持资源优先权和QoS的服务器</li> <li>多点会议服务器</li> <li>IVR、语音通知服务器</li> <li>VoiceMail服务器</li> <li>PBX应用和软交换</li> <li>应用层网关</li> <li>防火墙/NAT穿越应用</li> <li>私有服务器</li> <li>第三方呼叫控制应用</li> <li>业务生成环境运行时引擎</li> <li>会话边界控制器</li> <li>IMS中的S-CSCF/P-CSCF/I-CSCF</li> <li>SIP网间互联网关</li> <li>SBC及安全网关</li> <li>传真服务器、T.30到T.38网关</li></ul> <h3 id="快速体验"><a href="#快速体验" class="header-anchor">#</a> 快速体验</h3> <h4 id="安装基本的freeswitch系统"><a href="#安装基本的freeswitch系统" class="header-anchor">#</a> 安装基本的FreeSWITCH系统</h4> <p>FreeSWITCH支持Linux、Windows、Mac平台。</p> <ol><li><p>版本简介</p> <p>FreeSWITCH的版本号很有规律：版本号有3部分，以点号隔开。其中第1位为主版本，第2位为次版本，第3位作补丁及
更新标志。其中，从第2位看，偶数的版本为稳定版，奇数版本为开发版。</p></li> <li><p>在linux上安装</p> <p>![freeswitch安装文档]https://docs.ddoogg.cn/pages/a61298/#_3-%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE</p></li></ol> <h4 id="连接sip电话"><a href="#连接sip电话" class="header-anchor">#</a> 连接SIP电话</h4> <p>reeSWITCH最典型的应用是作为一个服务器，并用电话客户端软件连接到它。</p> <p>FreeSWITCH主要使用的通信协议是SIP。</p> <p>支持SIP的软电话常用的有X-Lite和Zoiper。</p> <p>X-Lite配置：</p> <p>选“Sip Account Setting…”，单击“Add”添加一个账号，填入一下参数：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>Display Name<span class="token punctuation">:</span><span class="token number">1000</span>
User Name<span class="token punctuation">:</span><span class="token number">1000</span>
Password<span class="token punctuation">:</span><span class="token number">1234</span>
Authorization user name<span class="token punctuation">:</span><span class="token number">1000</span>
Domain<span class="token punctuation">:</span>FreeSWITCH服务所在的IP地址
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="配置freeswitch"><a href="#配置freeswitch" class="header-anchor">#</a> 配置FreeSWITCH</h4> <p>FreeSWITCH配置文件默认放在conf/下。</p> <table><thead><tr><th>conf/目录和文件</th> <th><strong>说明</strong></th></tr></thead> <tbody><tr><td>–vars.xml</td> <td>一些常用变量</td></tr> <tr><td>–switch.xml</td> <td>主配置文件，它会使用include语句装入其他文件</td></tr> <tr><td>–autoload_configs</td> <td>目录，存放自动加载的配置文件</td></tr> <tr><td>—-modules.conf.xml</td> <td>配置当FreeSWITCH启动时自动装载哪些模块</td></tr> <tr><td>—-*.xml</td> <td>一般来说每个模块都有一个配置文件</td></tr> <tr><td>–chatplan</td> <td>聊天计划</td></tr> <tr><td>–dialplan</td> <td>拨号计划</td></tr> <tr><td>—-default.xml</td> <td>默认的拨号计划配置，一般用于内部用户路由</td></tr> <tr><td>—-public.xml</td> <td>默认的拨号计划配置，一般用于外部来的路由</td></tr> <tr><td>–drectory</td> <td>用户目录</td></tr> <tr><td>—-default</td> <td>默认的用户目录配置</td></tr> <tr><td>——*.xml</td> <td>SIP用户，每用户一个文件</td></tr> <tr><td>–ivr_menus</td> <td>IVR菜单</td></tr> <tr><td>–jingle_profiles</td> <td>连接Google Talk的相关配置</td></tr> <tr><td>–lang</td> <td>多语言支持</td></tr> <tr><td>—-en</td> <td>英语</td></tr> <tr><td>—-fr</td> <td>法语</td></tr> <tr><td>–mrcp_profiles</td> <td>MRCP的相关配置，用于跟第三方语音合成和语音识别系统对接</td></tr> <tr><td>–sip_profiles</td> <td>SIP配置文件</td></tr> <tr><td>—-internal.xml</td> <td>一个SIP profile，或称作一个SIP-UA，监听在本地IP及端口5060</td></tr> <tr><td></td> <td>一般供内网用户使用</td></tr> <tr><td>—-externa.xml</td> <td>另一个SIP-UA，用作外部连接，端口5080</td></tr> <tr><td>–skinny_profiles</td> <td>思科SCCP协议话机的配置文件</td></tr></tbody></table> <p>FreeSWITCH默认设置了20个用户，如果你需要更多的用户，3步：</p> <ol><li>在<code>conf/directory/default/</code>中增加一个配置文件。</li> <li>修改拨号计划使其他用户可以呼叫到它。</li> <li>重新加载配置文件使其生效。</li></ol> <h4 id="freeswitch用作软电话"><a href="#freeswitch用作软电话" class="header-anchor">#</a> FreeSWITCH用作软电话</h4> <p>也可以把FreeSWITCH简单地用作一个软电话。目前唯一支持CELT高清通话的软电话。</p> <p>FreeSWITCH使用mod_portaudio模块支持你本地的音频设备，默认是不编译的。在源码目录执行：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>make mod_portaudio
make mod_portaudio-install
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>安装完成后控制台执行：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>load mod_portaudio
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>尝试以下命令：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>pa looptest         （回路测试，echo）
pa call 9196        （呼叫9196）        
pa call 1000        （呼叫1000）
pa hangup           （挂机）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>没成功</p> <p>make mod_portaudio</p> <p>Makefile:967: *** You must install portaudio19-dev to build mod_portaudio.  Sto</p></blockquote> <h4 id="配置sip网关拨打外部电话"><a href="#配置sip网关拨打外部电话" class="header-anchor">#</a> 配置SIP网关拨打外部电话</h4> <p>如果你拥有某个运营商提供的SIP账号，那么你就可以通过配置SIP来拨打外部电话了。
该SIP账号（或提供该账号的设备）在FreeSWITCH中称为SIP网关（Gateway）。</p> <p>添加网关需要在<code>conf/sip_profiles/external/</code>中创建一个XML文件。如gwl.xml:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>gateway</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>gwl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>realm<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>SIP服务器地址，可以是IP或IP:端口号<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>SIP用户名<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>密码<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>gateway</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>执行命令使之生效：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>sofia profile external rescan
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>显示网关注册状态：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>sofia status
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果显示<code>gateway gwl</code>的状态是<code>REGED</code>,则表明已正确地注册到了网关上。</p> <p>先用命令试一下网关是否正常：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>originate sofia/gateway/gwl/xxxxxx &amp;echo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>该命令会通过网关gwl呼叫号码xxxxxx，被叫号码接听电话后，FreeSWITCH会执行echo程序，
就能听到自己的回音了。</p> <h5 id="从某一分机上呼出"><a href="#从某一分机上呼出" class="header-anchor">#</a> 从某一分机上呼出</h5> <p>常见的PBX一般是内部拨小号，打外部电话就需要加拨0或先按9。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extension</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>call out<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>destination_number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^0(\d+)$<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bridge<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sofia/gateway/gwl/$1<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extension</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>其中，匹配0后面的变量并存入到变量$1中。然后通过bridge程序通过网关gwl打出该号码。</p> <h5 id="呼入电话处理"><a href="#呼入电话处理" class="header-anchor">#</a> 呼入电话处理</h5> <p>一般来说，呼入的DID就是你的SIP号码。</p> <p>创建XML文件放到<code>conf/dialplan/public/my_did.xml</code>中：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extension</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>public_did<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>destination_number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^(你的DID)$<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transfer<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1000 XML default<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extension</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="运行freeswitch"><a href="#运行freeswitch" class="header-anchor">#</a> 运行FreeSWITCH</h2> <h3 id="命令行参数"><a href="#命令行参数" class="header-anchor">#</a> 命令行参数</h3> <p>一般来讲，FreeSWITCH不需要任何命令行参数就可以启动。</p> <p>使用<code>freeswitch -h</code>或<code>freeswitch -help</code>或<code>freeswitch --help</code>显示帮助信息</p> <p>常用的两个：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>freeswitch -nc              <span class="token comment">#后台启动</span>
freeswitch -nonat           <span class="token comment">#关掉NAT启动</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="系统启动脚本"><a href="#系统启动脚本" class="header-anchor">#</a> 系统启动脚本</h3> <p>在真正生成系统上，一般需要FreeSWITCH能跟系统一起启动。</p> <ul><li>在UNIX类系统上，启动脚本一般放在etc/init.d/下。可以在源码目录下找到不同系统启动脚本debian/freeswitch.init及build/freeswitch.init.*。</li> <li>在Windows上，可以将FreeSWITCH注册为服务。</li></ul> <h3 id="判断freeswitch是否运行"><a href="#判断freeswitch是否运行" class="header-anchor">#</a> 判断FreeSWITCH是否运行</h3> <p>UNIX类系统下：</p> <ol><li><p>看进程是否存在。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">ps</span> aux <span class="token operator">|</span> <span class="token function">grep</span> freeswitch
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>看相关端口是否被占用。</p> <div class="language-sehll line-numbers-mode"><pre class="language-text"><code>netstat -an | grep 5060
netstat -anp | grep 5060
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ol> <p>Windows平台：</p> <p>netstat命令、任务管理器。</p> <h3 id="控制台与命令客户端"><a href="#控制台与命令客户端" class="header-anchor">#</a> 控制台与命令客户端</h3> <p>系统不带参数启动到控制台，在控制台上可以输入各种命令以控制或查询FreeSWITCH的状态。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>version         <span class="token comment">-- 显示当前版本</span>
<span class="token keyword">status</span>          <span class="token comment">-- 显示当前状态   </span>
sofia <span class="token keyword">status</span>    <span class="token comment">-- 显示sofia状态</span>
help            <span class="token comment">-- 显示帮助</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>为了调试方便，还在conf/autoload_configs/switch.conf.xml中定义了一些控制台快捷键。</p> <p>FreeSWITCH是一个典型的Client/Server结构，不管FreeSWITCH运行在前台还是后台，你都可以使
用客户端软件fs_cli连接FreeSWITCH。</p> <p>fs_cli使用FreeSWITCH的ESL协议与FreeSWITCH通信。</p> <p>fs_cli也支持很多命令行参数，值得一提的是-x参数，它允许执行一条命令后退出。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ bin/fs_cli -x <span class="token string">&quot;version&quot;</span>                                  <span class="token comment"># 显示版本号</span>
$ bin/fs_cli -x <span class="token string">&quot;status&quot;</span>                                   <span class="token comment"># 显示状态</span>
$ bin/fs_cli -x <span class="token string">&quot;originate user/1000 &amp;bridge(user/1001)&quot;</span>       <span class="token comment"># 回拨</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>fs_cli可以连接到其他机器上的FreeSWITCH，用户主目录编辑配置文件<code>.fs_cli_conf</code></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>server1<span class="token punctuation">]</span>
<span class="token function">host</span>        <span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token number">192.168</span>.1.10
port        <span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token number">8021</span>
password    <span class="token operator">=</span><span class="token operator">&gt;</span>  secret_password
debug       <span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token number">7</span>

<span class="token punctuation">[</span>server2<span class="token punctuation">]</span>
<span class="token function">host</span>        <span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token number">192.168</span>.1.11
port        <span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token number">8021</span>
password    <span class="token operator">=</span><span class="token operator">&gt;</span>  secret_password
debug       <span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>配置好，可以这样使用：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ fs_cli server1
$ fs_cli server2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>fs_cli有几个特殊命令，以”/”开头。这些命令不直接发送到FreeSWITCH，而是先由fs_cli处理。</p> <h3 id="呼叫"><a href="#呼叫" class="header-anchor">#</a> 呼叫</h3> <h4 id="发起呼叫"><a href="#发起呼叫" class="header-anchor">#</a> 发起呼叫</h4> <p>使用<code>originate</code>命令发起一次呼叫。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>freeswitch<span class="token operator">&gt;</span> originate user/1000 <span class="token operator">&amp;</span><span class="token builtin class-name">echo</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>呼叫1000,1000接听后，将听到回声。</p> <h4 id="呼叫字符串"><a href="#呼叫字符串" class="header-anchor">#</a> 呼叫字符串</h4> <p>“user/1000”称为呼叫字符串。</p> <p>假设alice的UA地址为192.168.4.4:5090，已向FreeSWITCH注册。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>freeswitch<span class="token operator">&gt;</span> sofia status profile internal reg
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以看到alice的注册信息。</p> <p>使用originate命令呼叫user/alice这个呼叫字符串时，会找到Cantact地址<code>sip:alice@192.168.4.4:5090</code>并向其发送INVITE请求</p> <h4 id="api与app"><a href="#api与app" class="header-anchor">#</a> API与App</h4> <p>FreeSWITCH的命令不仅可以在控制台上使用，也可以在各种嵌入式脚本、Event Socket或HTTP RPC上使用，
所有命令都遵循一个抽象的接口，因而这些命令又称为API Commands。</p> <p>echo则是一个常用的应用程序（Application，App），它的作用是控制一个Channel的一端。
alice是一端，另一端是echo。这种通话称为“单腿通话（one-legged connection）”。</p> <p>可以将电话“挂起”，park便是实现这个功能。</p> <p>hold比较友好，等待同时播放音乐。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>freeswitch<span class="token operator">&gt;</span> originate user/alice <span class="token operator">&amp;</span>hold
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>播放特定的声音</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>freeswitch<span class="token operator">&gt;</span> originate user/alice <span class="token operator">&amp;</span>playback<span class="token punctuation">(</span>/root/welcome.wav<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>或直接录音</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>freeswitch<span class="token operator">&gt;</span> originate user/alice <span class="token operator">&amp;</span>record<span class="token punctuation">(</span>/tmp/voice_of_alice.wav<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>大多数情况下，FreeSWITCH都是作为一个B2BUA来桥接两个UA进行通话的。在alice接听电话后，bridge程序可以在启动一个UA呼叫bob</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>freeswitch<span class="token operator">&gt;</span> originate user/alice <span class="token operator">&amp;</span>brige<span class="token punctuation">(</span>user/bob<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>另一种方式</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>originate user/alice <span class="token operator">&amp;</span>park
originate user/bob <span class="token operator">&amp;</span>park
show channels
uuid_bridge <span class="token operator">&lt;</span>alice_uuid<span class="token operator">&gt;</span><span class="token operator">&lt;</span>bob_uuid<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>分别呼叫alice和bob，然后通过uuid_bridge命令将两个Channel桥接起来</p> <p>两条命令（API）：originate和uuid_bridge
几个程序（App）：echo、park和bridge</p> <blockquote><p><strong>简单来说，一个App是一个程序（Application），它作为一个Channel一端与另一端的UA进行通信，相当于它工作在Channel内部；
而一个API则是独立于一个Channel之外的，它只能通过找到Channel的UUID来控制一个Channel（如果需要的话），相当于一个第三者。</strong>
这就是API和App最本质的区别。</p></blockquote> <ul><li>大部分API都是在mod_commands模块中加载的。</li> <li>App则在mod_dptools中。</li></ul> <h4 id="api命名帮助"><a href="#api命名帮助" class="header-anchor">#</a> API命名帮助</h4> <p>使用help可以列出所有命令的帮助信息。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>freeswitch<span class="token operator">&gt;</span> <span class="token builtin class-name">help</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="freeswitch架构"><a href="#freeswitch架构" class="header-anchor">#</a> FreeSWITCH架构</h2> <h3 id="总体架构"><a href="#总体架构" class="header-anchor">#</a> 总体架构</h3> <p>总的来说，FreeSWITCH由一个稳定的核心（Core）以及一些外围模块组成。</p> <p>FreeSWITCH内部使用线程模型来处理并发请求，每个连接都在单独的线程中进行处理，不同的线程间通过Mutex互斥访问共享资源，并
通过消息和异步事件等方式进行通信。</p> <p>FreeSWITCH的核心非常短小精悍。绝大多数应用层的功能都在外围模块中实现。外围模块通过核心提供的Public API与核心进行通信，
而核心则通过回调（或称钩子）机制执行外围模块中的代码。</p> <h4 id="核心"><a href="#核心" class="header-anchor">#</a> 核心</h4> <p>FreeSWITCH的核心是Core，它包含了关键的数据结构和复杂的代码、状态机、数据库等，这些代码只出现在核心中，并保持了最大限度的抽象和重用。外围模块只能通过核心代码提供的公共应用程序接口调用核心的功能。</p> <ol><li><p>1.数据库（DB）</p> <p>FreeSWITCH的核心除了使用内部队列、哈希表存储数据外，也使用外部的关系型数据库存储数据。</p></li> <li><p>公共应用程序接口（Public API）</p> <p>核心层实现了一些Public API。这些Public API可以被外围的模块调用。</p></li> <li><p>接口（Interface）</p> <p>提供了很多抽象的接口，具体实现一般由外围的模块负责，核心层通过回调（钩子）方式调用具体的实现代码或函数。</p></li> <li><p>事件（Event）</p> <p>内部也使用消息和事件机制进行进程间和模块间通信。</p></li></ol> <h4 id="接口实现"><a href="#接口实现" class="header-anchor">#</a> 接口实现</h4> <p>接口都是抽象的，其中只有少量在核心中有具体实现（如PCM编码解码实现），大部分最终由外部实现。</p> <ul><li>终点（Endpoint）。</li> <li>拨号计划（Dialplan）。</li> <li>聊天计划（Chatplan）。</li> <li>应用程序（Application，APP）。</li> <li>命令接口（FSAPI）。</li> <li>XML接口（XML Interface）。</li> <li>编解码器（Codec）。</li> <li>语音识别及语音合成（ASR/TTS）。</li> <li>格式、文件接口（Format、File Interface）。</li> <li>日志（Logger）。</li> <li>定时器（Timer）。</li> <li>嵌入式语言（Embeded Language）。</li> <li>事件套接字（Event Socket）。</li></ul> <h3 id="目录结构"><a href="#目录结构" class="header-anchor">#</a> 目录结构</h3> <table><thead><tr><th>目录</th> <th>说明</th></tr></thead> <tbody><tr><td>bin</td> <td>可执行程序</td></tr> <tr><td>db</td> <td>系统数据库（sqlite），将呼叫信息存放到数据库中，这样在查询时就无须对核心数据结构进行加锁了</td></tr> <tr><td>htdocs</td> <td>HTTP Server根目录</td></tr> <tr><td>lib</td> <td>库文件</td></tr> <tr><td>mod</td> <td>可加载模块</td></tr> <tr><td>run</td> <td>运行目录，存放FreeSWITCH运行时PID</td></tr> <tr><td>sounds</td> <td>声音文件，使用playback()时默认的寻找路径</td></tr> <tr><td>grammer</td> <td>语法，用于ASR</td></tr> <tr><td>include</td> <td>头文件</td></tr> <tr><td>recordings</td> <td>录音，使用record()时默认的存放路径</td></tr> <tr><td>scripts</td> <td>嵌入式语言写的脚本，如使用lua()、luarun()、jsrun等默认寻找的路劲</td></tr> <tr><td>storage</td> <td>语音留言（Voicemail）的录音</td></tr> <tr><td>conf</td> <td>配置文件</td></tr></tbody></table> <h3 id="配置文件"><a href="#配置文件" class="header-anchor">#</a> 配置文件</h3> <p>在系统装载时，XML解析器会将所有的XML文件组织在一起，并读入内存，组成一个大的XML文档（Document），称为XML注册表。</p> <h4 id="freeswitch-xml"><a href="#freeswitch-xml" class="header-anchor">#</a> freeswitch.xml</h4> <p>freeswitch.xml是所有XML文件的黏合剂。</p> <h4 id="vars-xml"><a href="#vars-xml" class="header-anchor">#</a> vars.xml</h4> <p>vars.xml主要通过X-PRE-PROCESS指令定义了一些全局变量。如</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">&lt;</span>X-PRE-PROCESS <span class="token assign-left variable">cmd</span><span class="token operator">=</span><span class="token string">&quot;set&quot;</span> <span class="token assign-left variable">data</span><span class="token operator">=</span><span class="token string">&quot;domain=$<span class="token variable">${local_ip_v4}</span>&quot;</span>/<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>X-PRE-PROCESS <span class="token assign-left variable">cmd</span><span class="token operator">=</span><span class="token string">&quot;set&quot;</span> <span class="token assign-left variable">data</span><span class="token operator">=</span><span class="token string">&quot;domain_name=$<span class="token variable">${domain}</span>&quot;</span>/<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>X-PRE-PROCESS <span class="token assign-left variable">cmd</span><span class="token operator">=</span><span class="token string">&quot;set&quot;</span> <span class="token assign-left variable">data</span><span class="token operator">=</span><span class="token string">&quot;hold_music=local_stream://moh&quot;</span>/<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>X-PRE-PROCESS <span class="token assign-left variable">cmd</span><span class="token operator">=</span><span class="token string">&quot;set&quot;</span> <span class="token assign-left variable">data</span><span class="token operator">=</span><span class="token string">&quot;use_profile=internal&quot;</span>/<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>实际使用中，可以使用global_getvar或API命令来查看这些变量的值。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>freeswitch<span class="token operator">&gt;</span> global_getvar sound_prefix
freeswitch<span class="token operator">&gt;</span> global_getvar local_ip_v4
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="autoload-configs目录"><a href="#autoload-configs目录" class="header-anchor">#</a> autoload_configs目录</h4> <p>autoload_config目录下的各种配置文件会在系统启动时装入。一般来说都是块级的配置文件，每个模块对应一个。</p> <h4 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h4> <ul><li>dialplan目录：该目录定义了XML拨号计划。</li> <li>ivr_menues目录：该目录下存放了默认的一些IVR菜单例子。</li> <li>directory目录：作为注册服务器时，用于配置本地用户，配置信息称为用户目录。</li></ul> <h3 id="xml用户目录"><a href="#xml用户目录" class="header-anchor">#</a> XML用户目录</h3> <p>SIP并不要求一定要注册才能可以打电话，但是通话前的用户认证参数仍需要在用户目录中进行配置。</p> <h3 id="呼叫相关概念"><a href="#呼叫相关概念" class="header-anchor">#</a> 呼叫相关概念</h3> <h4 id="来去话、session、channel与call"><a href="#来去话、session、channel与call" class="header-anchor">#</a> 来去话、Session、Channel与Call</h4> <p>Bob到FreeSWITCH的通话称为来话，FreeSWITCH作为一个B2BUA再去呼叫Alice时，称为去话。</p> <p>无论来话还是却话，都会启动一个Session，控制着整个呼叫，直到结束。每个Session都控制着一个Channel。
在逻辑上组成一个通话，称为Call。</p> <h4 id="回铃音与early-media"><a href="#回铃音与early-media" class="header-anchor">#</a> 回铃音与Early Media</h4> <p>A-交换机a-交换机b-B</p> <p>为了在A端能听到B端特殊的回铃音，回铃音只能由B端交换机发送。这些回铃音称为Early Media。</p> <p>理论上将，B接听电话后交换机b可以一直不向交换机a发送应答消息，而是将真正的话音数据伪装成Early Media，实现“免费通话”。</p> <h4 id="全局变量与局部变量"><a href="#全局变量与局部变量" class="header-anchor">#</a> 全局变量与局部变量</h4> <ul><li><p>全局变量 $${var}</p></li> <li><p>局部变量 ${var}</p></li> <li><p>局部变量 ${var}</p></li></ul> <h2 id="拨号计划"><a href="#拨号计划" class="header-anchor">#</a> 拨号计划</h2> <p>拨号计划主要作用就是对电话进行路由，决定和影响通话的流程。</p> <h3 id="简单测试"><a href="#简单测试" class="header-anchor">#</a> 简单测试</h3> <ol><li><p>默认配置文件位置</p> <p>/usr/local/freeswitch/conf/dialplan</p></li> <li><p>默认配置文件</p> <p><img src="https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220228163934.png" alt=""></p></li> <li><p>增加一个简单的配置,测试的案例最好放在配置的前面</p> <p>#vi /usr/local/freeswitch/conf/dialplan/default.xml</p></li></ol> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extension</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>My Echo Test<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>destination_number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^echo|1234$<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>answer<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>echo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extension</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="4"><li><p>控制台命令，生效配置文件</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>reloadxml 或者F6
console loglevel debug 或则F8
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ol> <h3 id="xmldialplan"><a href="#xmldialplan" class="header-anchor">#</a> XMLDialplan</h3> <p>可以是静态配置的，也可以使用动态配置方式从其他服务器或脚本中动态获取。</p> <h4 id="配置文件的结构"><a href="#配置文件的结构" class="header-anchor">#</a> 配置文件的结构</h4> <p>拨号计划由多个Context组成。每个Context中有多个Extension。Context就是多个Extension的逻辑集合，
它相当于一个分组。一个Context中的Extension与其他Context中的Extension在逻辑上是隔离的。</p> <h4 id="默认的配置文件简介"><a href="#默认的配置文件简介" class="header-anchor">#</a> 默认的配置文件简介</h4> <p>系统默认提供的配置文件包含三个Context，分别是default、feature和public。</p> <ul><li>default：默认的Dialplan，一般来说注册用户都可以通过它来打电话。</li> <li>public：一般用于接收外来呼叫。外部来的呼叫是不可信的，要求更严格的控制</li> <li>在 <code>default</code> 和 <code>public</code>配置文件中可以引用对应目录default和public中的.xml文件</li></ul> <h4 id="正则表达式"><a href="#正则表达式" class="header-anchor">#</a> 正则表达式</h4> <p>使用与Perl兼容的正则表达式匹配算法。</p> <p>正则表达式的例子及说明：</p> <table><thead><tr><th>例子</th> <th>说明</th></tr></thead> <tbody><tr><td>^1234$</td> <td>&quot;^&quot;配字符中的开头,“$”配字符串的结尾所以本表达式严格匹配1234</td></tr> <tr><td>^1234|5678$</td> <td>&quot;|&quot;是或的意思,表示匹配1234或5678</td></tr> <tr><td>^123[0-9]$</td> <td>&quot;[]&quot;表示配其中的任意一个字符,其中&quot;-&quot;表示一个区间,即0到9它等于[0123456789],也就是说它会匹配1230,1231,1232...1239</td></tr> <tr><td>^123\d$</td> <td>同上,d等于[0-9]</td></tr> <tr><td>^123\d+$</td> <td>&quot;+&quot;号表示匹配1个或多个它前面的字符,这里由于&quot;+&quot;前面是&quot;\d&quot;,所以它就等于1个或多个数字,实际上它匹配任意以123开头的至少4位数的数字,如1230，12300，12311，123456789等</td></tr> <tr><td>^123\d*$</td> <td>&quot;*&quot;号与“+”号的不同在于,它匹配0个或多个面的字符,所以,它配以123开头至少3位数的数字,如123,123789</td></tr> <tr><td>^123</td> <td>跟上面一样,由于没有结尾的S,它匹配任何以123开头的数字申,但除此之开,它还匹配后面是字母的情况,如123abc</td></tr> <tr><td>123$</td> <td>匹配任何以123结尾的字符</td></tr> <tr><td>^123\d{5}$</td> <td>{5}表示精确匹配5位,包含它前面的字符,在这里,宅匹配以123开头的所有8位电话号码</td></tr> <tr><td>^123(\d+)$</td> <td>&quot;()&quot;在匹配中不起作用,因而此处^123\d+$是相同的;但它对匹配结果有作用,匹配结果中除123之外的数字都将储在S1这个变量中,在后面可以引用</td></tr> <tr><td>^123(\d)(\d+)$</td> <td>果用它跟12345678匹配,则匹配成功,结果是$1=4,$2=5678</td></tr> <tr><td>.</td> <td>最后说明,&quot;.&quot;匹配任意一个字符,如果你写了“.*”,则它会匹配任意字符</td></tr></tbody></table> <h4 id="通道变量"><a href="#通道变量" class="header-anchor">#</a> 通道变量</h4> <p>每一次呼叫都由一条或多条“腿”（Call Leg）组成，其中的一条腿又称为一个Channel，每一个Channel都有很多属性，用于标识Channel的状态、性能等，这些属性称为Channel Variable（通道变量）。</p> <p>查看通道变量</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extension</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Show Channel Variable<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>destination_number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^1235|info$<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>info<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extension</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>使用通道变量</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extension</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Accessing Channel Variable<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>destination_number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^1236(\d+)$<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>log<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>INFO Hahaha, i know you challed ${destination_number}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>log<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>NOTICE, The Last few digits is $1 <span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>log<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ERR, this is not actually an error, just jocking :), have fun! <span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hangup<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extension</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>拨打1236789测试</p> <p>info中显示的变量与通道变量的对应关系</p> <p>[]: https://freeswitch.org/confluence/display/FREESWITCH/Channel+Variables</p> <h4 id="测试条件"><a href="#测试条件" class="header-anchor">#</a> 测试条件</h4> <p>最简单的测试条件</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>destination_number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^1234$<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>network_addr<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^192\.168\.7\.7$<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Dialplan中的测试条件</p> <table><thead><tr><th>变量</th> <th>说明</th></tr></thead> <tbody><tr><td>context</td> <td>Dialplan当前的Context</td></tr> <tr><td>rdnis</td> <td>被转移的号码</td></tr> <tr><td>destination_number</td> <td>被叫号码</td></tr> <tr><td>diaplan</td> <td>Dialplan模块的名字，如XML、YAML、inline、asterisk、enum等</td></tr> <tr><td>caller_id_name</td> <td>主叫（来电显示）的名称</td></tr> <tr><td>caller_id_number</td> <td>主叫号码</td></tr> <tr><td>ani</td> <td>主叫的自动识别</td></tr> <tr><td>aniii</td> <td>主叫类型，如投币电话</td></tr> <tr><td>uuid</td> <td>本Channel的唯一标志</td></tr> <tr><td>source</td> <td>呼叫源，来自哪一个FreeSWITCH模块，如mod_portaudio, mod_sofi</td></tr> <tr><td>chan_name</td> <td>Channel名字</td></tr> <tr><td>network_addr</td> <td>主叫ip地址</td></tr> <tr><td>year</td> <td>当前的年，0~9999</td></tr> <tr><td>yday</td> <td>一年中的第几天，1~366</td></tr> <tr><td>mon</td> <td>月，1~12</td></tr> <tr><td>mday</td> <td>日，1~31</td></tr> <tr><td>week</td> <td>一年中的第几周，1~53</td></tr> <tr><td>mweek</td> <td>本月中的第几周，1~6</td></tr> <tr><td>wday</td> <td>一周中的第几天，1~7</td></tr> <tr><td>hour</td> <td>小时，0~23</td></tr> <tr><td>minute</td> <td>分，0~59</td></tr> <tr><td>minute-of-day</td> <td>一天中的第几分钟，（1~1440）</td></tr></tbody></table> <p>接受用户在用户目录中设置的变量，但要注意必须使用${}对变量进行引用。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">&lt;</span>condition <span class="token assign-left variable">field</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${toll_allow}</span>&quot;</span> <span class="token assign-left variable">expression</span><span class="token operator">=</span><span class="token string">&quot;international&quot;</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在用户目录设置以下变量，然后在dialplan中通过condition进行测试</p> <p>用户目录中的设置：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1000<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>variables</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>variable</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>my_test_var<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>my_test_value<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>variables</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>dialplan中的测试条件：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${my_test_var}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^my_test_value$<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>测试条件不可嵌套，但可迭加。构成“逻辑与”关系。平行的condition是&quot;逻辑与&quot;的关系。</p> <p>break参数可以使condition构成其他关系，如不指定默认为on-false。（假设两个条件分别为A何B）</p> <ul><li>on-false。在第一次匹配失败时停止，退出本extension。结果相当于 A and B</li> <li>on-true。在第一次匹配成功时停止。（会完成相应的Action，然后继续执行其他的extension）,不成功就继续，相当于（（not A）and B）</li> <li>always。不管是否匹配，都停止。</li> <li>never。不管是否匹配，都继续。</li></ul> <p>通过break参数，复查场景放到一个extension中</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extension</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>testing break<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>destination_number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^1234$<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>network_addr<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^192\.169\.7\.7$<span class="token punctuation">&quot;</span></span> <span class="token attr-name">break</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>on-true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>playback<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>good-morning.wav<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>network_addr<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^192\.169\.7\.8$<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>anti-action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>playback<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>good-night.wav<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extension</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="动作与反动作"><a href="#动作与反动作" class="header-anchor">#</a> 动作与反动作</h4> <p>除使用condition的break机制来完成复杂的条件以外，你还可以使用“反动作”来达到类似的目的。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extension</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Action and Anti-Action<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>destination_number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^1234$<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>network_addr<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^192\.169\.7\.7$<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>playback<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>good-morning.wav<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>anti-action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>playback<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>good-night.wav<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extension</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="工作机制深入剖析"><a href="#工作机制深入剖析" class="header-anchor">#</a> 工作机制深入剖析</h4> <p>new-&gt;init-&gt;routing&lt;-&gt;execute-&gt;hangup-&gt;reporting-&gt;destory</p> <p>ROUNTING和EXECUTE是属于两个不同的阶段，只有ROUTING完毕后才会进行EXECUTE阶段的操作。</p> <h4 id="内联执行"><a href="#内联执行" class="header-anchor">#</a> 内联执行</h4> <p>在Hunting阶段，如果发现带有inline的Action，会直接执行它，而不用等到EXECUT阶段。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">inline</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>greeting=no-greeting.wav<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>inline会打乱执行顺序，所以使用不当可能会产生非预期的结果。</p> <h4 id="实例解析"><a href="#实例解析" class="header-anchor">#</a> 实例解析</h4> <ol><li><p>Local_Extension</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extension</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Local_Extension<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>destination_number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^(10[01][0-9])$<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- many actions，此处省略 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extension</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>1000呼叫1001时，匹配的结果会放入变量$1中，因此这里的$1=1001。</p> <p>省略的“many actions”里面的内容：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dialed_extension=$1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>export<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dialed_extension=$1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>set是将变量设置在当前Channel上，及a-leg。</p> <p>export是将变量设置在b-leg上，还设置了一个特殊的值。</p> <p>上面第二行相当于：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dialed_extension=$1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>export_vars=dialed_extension<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>接着：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bind_meta_app<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1 b s execute_extension::dx XML features<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bind_meta_app<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2 b s record_session::$${recordings_dir}/${caller_id_number}.${strftime{%Y-%m-%d-%H-%M-%S}}.wav<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bind_meta_app<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>3 b s execute_extension::cf XML features<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bind_meta_app<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>4 b s execute_extension::att_xfer XML features<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>bind_meta_app的作用是在该Channel上绑定DTMF（Dual Tone Multi Frequency（双音多频））。上面分别绑定了1、2、3、4四个按钮，都绑定在了b-leg上。</p> <p>接着设置回铃音：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ringback=${us-ring}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果发生呼叫转移，听到回铃音：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transfer_ringback=$${hold_music}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>设置呼叫超时变量：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>call_timeout=30<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hangup_after_bridge=true<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>continue_on_fail=true<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hash<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>insert/${domain_name}-call_return/${dialed_extension}/${caller_id_number}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hash<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>insert/${domain_name}-last_dial_ext/${dialed_extension}/${uuid}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hash<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>insert/${domain_name}-last_dial_ext/${called_party_callgroup}/${uuid}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hash<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>insert/${domain_name}-last_dial_ext/global/${uuid}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>最后一句：向domainname−lastdialext这个hash表中插入一个global键，值是domainname−lastdialext这个hash表中插入一个global键，值是{uuid}。</p> <p>set是将变量设置在Channel上，以通道变量形式存在，而hash保存到内存的哈希表数据结构中。</p> <p>设置通道变量：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>called_party_callgroup=${user_data(${dialed_extension}@${domain_name} var callgroup)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>哈希表中插入数据：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hash<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>insert/${domain_name}-last_dial/${called_party_callgroup}/${uuid}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>终于到了一个干实事的地方：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bridge<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{sip_invite_domain=$${domain}}user/${dialed_extension}@${domain_name}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>呼叫字符串翻译出来就是：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>{sip_invite_domain=192.168.7.2}user/1001@192.168.2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>“{}”里是设置通道变量。等价于：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>export<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nolocal:sip_invite_domain=192.168.7.2<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bridge<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>user/1001@192.168.7.2<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>路由完成，接下来可能有几种情况：</p> <ul><li>被叫应答</li> <li>被叫忙</li> <li>被叫无应答</li> <li>被叫无应答</li> <li>其他情况…</li></ul> <p>bridge一直阻塞，1000挂机，Dialplan没有必要执行了，产生计费信息，并销毁a-leg。</p> <p>1001挂机，a-leg依然存在。如果设置了hangup_after_bridge=true, a-leg也会销毁。</p> <p>通过给continue_on_fail不同的值，决定在什么情况下继续。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>continue_on_fail=USER_BUSY,NO_ANSWER<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>answer<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sleep<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1000<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>voicemail<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>default ${domain_name} ${dialed_extension}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>暂停1秒，然后转到1001的语音信箱。</p></li> <li><p>回声和延迟回声</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extension</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>delay_echo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>destination_number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^9196$<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>answer<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>delay_echo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>5000<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extension</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extension</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>delay_echo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>destination_number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^9196$<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>answer<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>delay_echo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>5000<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extension</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>会议</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extension</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nb_conferences<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>destination_number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^(30\d{2})$<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>answer<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>conference<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>$1-${domain_name}@default<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extension</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>30开头的4位数字呼叫，会进入电话会议。</p> <p>3001-192.168.7.2@default, 3001-192.168.7.2是电话会议的名称，default表示一个会议的porfile定义了会议的参数信息</p></li> <li><p>将通话的双发转入会议</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bind_meta_app<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>3 b s execute_extension::cf XML features<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>1000呼叫1001,1001摘机与1000通话。1001通过按“*3”这个DTMF按键触发execute_extension动作。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extension</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cf<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>destination_number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^cf$<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>answer<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transfer<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>-both 30${dialed_extension:2} XML default<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extension</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>transfer一行等价于：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transfer<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>-both 3001 XML default<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>-both表示将两条腿分别转到3001这个extension上。</p></li></ol> <h3 id="inline-dialplan"><a href="#inline-dialplan" class="header-anchor">#</a> inline Dialplan</h3> <p>inline Dialplan称为内联拨号计划。没有extension，也没有复杂的condition，简单的叠加action，紧凑的语法格式</p> <p>语法格式：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>app1:arg1,app2:arg2,app3:arg3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-xml line-numbers-mode"><pre class="language-xml"><code>originate user/1000 echo inline
originate user/1000 answer,echo inline
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="其他dialplan"><a href="#其他dialplan" class="header-anchor">#</a> 其他Dialplan</h3> <p>查看系统支持多少Dialplan</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>show dialplan
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="常用的dialplan-app"><a href="#常用的dialplan-app" class="header-anchor">#</a> 常用的Dialplan App</h3> <p>FreeSWITCH中有超过140个App，常用的有：</p> <ol><li><p><strong>set</strong></p> <p>设置一个通道变量。</p></li> <li><p><strong>echo</strong></p> <p>回音</p></li> <li><p><strong>info</strong></p> <p>日志打印全部通道变量。</p></li> <li><p><strong>answer</strong></p> <p>用于应答一路呼叫。</p></li> <li><p><strong>bridge</strong></p> <p>负责桥接另一条腿。</p></li> <li><p><strong>playback</strong></p> <p>playback用于给Channel放音。</p></li> <li><p><strong>sleep</strong></p> <p>设置可以等待/暂停的一段时间。</p></li> <li><p><strong>ring_ready</strong></p> <p>在SIP中给对方回180消息，通知对方可以振铃了。</p></li> <li><p><strong>pre_answer</strong></p> <p>在SIP中给对方回复183消息，后续的playbakck之类的动作作为早期媒体发送给对方。</p></li> <li><p><strong>read</strong></p> <p>用于实现播放声音并且等待接收DTMF按键。</p></li> <li><p><strong>play_and_get_digits</strong></p> <p>与read类似，更高级。</p></li></ol> <h3 id="在dialplan中使用api命令"><a href="#在dialplan中使用api命令" class="header-anchor">#</a> 在Dialplan中使用API命令</h3> <p>API调用一般是通过set来执行的：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>api_result=${status()}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>api_result=${version()}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>api_result=${strftime()}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>api_result=${expr(1+1)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="深入理解通道变量以及相关操作"><a href="#深入理解通道变量以及相关操作" class="header-anchor">#</a> 深入理解通道变量以及相关操作</h3> <p>给变量赋值：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>my_var=my_value<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>export可以对a-leg和b-leg同时赋值（即使此时b-leg不存在）:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>export<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>my_var=my_value<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>export可以通过nolcal参数将变量限制仅复制到b-leg上：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>export<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nolocal:my_var=my_value<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>a-leg上的一些值复制到b-leg上：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>export<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>var1=$var1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>export<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>var2=$var2<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>export<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>var3=$var3<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>等价于：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>export_vars=var1,var2,var3<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>取消Variable定义只需对它赋一个特殊值–”<em>undef</em>“或使用unset App</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>var1=_undef_<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>unset<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>var1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>截取Variable值</p> <p>语法：${var:位置:长度}</p> <h2 id="sip协议"><a href="#sip协议" class="header-anchor">#</a> SIP协议</h2> <h3 id="sip协议基础"><a href="#sip协议基础" class="header-anchor">#</a> SIP协议基础</h3> <p>会话初始协议（Session Initiation Protocal）是一个控制发起、修改和终结交互式多媒体会话的信令协议。</p> <h4 id="http与sip协议基础"><a href="#http与sip协议基础" class="header-anchor">#</a> HTTP与SIP协议基础</h4> <p>SIP是一个基于文本的协议，与HTTP和SMTP类似。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code>HTTP:
GET /index.html HTTP/1.1
SIP:
INVITE sip:seven@freeswitch.org.cn SIP/2.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="sip基础概念和相关元素"><a href="#sip基础概念和相关元素" class="header-anchor">#</a> SIP基础概念和相关元素</h4> <p>SIP是一个对等协议，类似P2P。</p> <p>在SIP网络中，Alice和Bob都称为用户代理（User Agent，UA）。UA是在SIP网络中发起或响应SIP处理的逻辑实体。
UA是有状态的。UA有两种：一种是UAC（UA Client），发起SIP请求的一方；另一种是UAS（UA Server），接受并
发送响应的一方。一般来说，UA都会实现上述两种功能。</p> <p>还有一种特殊的UA称为背靠背代理（Back-to-Back UA，B2BUA）。FreeSWITCH就是一个典型的B2BUA。</p> <p>边界会话控制器（Session Border Controller，SBC）。主要位于一堆SIP服务器的边界，用于隐藏内部服务器的
拓扑结构、抵御外来攻击等。</p> <h4 id="sip协议的基本方法和头域简介"><a href="#sip协议的基本方法和头域简介" class="header-anchor">#</a> SIP协议的基本方法和头域简介</h4> <p>SIP的6种基本方法:</p> <table><thead><tr><th>基本方法</th> <th>说明</th></tr></thead> <tbody><tr><td>REGISTER</td> <td>注册联系信息</td></tr> <tr><td>INVITE</td> <td>初始化一个会话，可以理解为发起一个呼叫</td></tr> <tr><td>ASK</td> <td>对INVITE消息的最终响应</td></tr> <tr><td>CNACEL</td> <td>取消一个等待处理或正在处理的请求</td></tr> <tr><td>BYE</td> <td>终止一个电话</td></tr> <tr><td>OPTIONS</td> <td>查询和服务器能力，也可以用作ping测试</td></tr></tbody></table> <p>SIP还定义了一些扩展方法，如SUBSCRIBE、NOTIFY、MESSAGE、REFER、INFO等。</p> <p>SIP必须包含的头域:</p> <table><thead><tr><th>名称</th> <th>描述</th></tr></thead> <tbody><tr><td>Call-ID</td> <td>用于区分不同会话的唯一标志</td></tr> <tr><td>CSeq</td> <td>顺序号，用于在同一会话中区分事务</td></tr> <tr><td>From</td> <td>说明请求来源</td></tr> <tr><td>To</td> <td>说明请求接受方</td></tr> <tr><td>Max-Forwards</td> <td>限制跳跃点数和最大转发次数</td></tr> <tr><td>Via</td> <td>描述请求消息经过的路径</td></tr></tbody></table> <h3 id="sip注册"><a href="#sip注册" class="header-anchor">#</a> SIP注册</h3> <p>注册流程</p> <p><img src="https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220302173657.png" alt=""></p> <p>Alice向FreeSWITCH发起注册（REGISTER）请求，FreeSWITCH返回401消息对Alice发起Challenge（挑战），Alice将自己的用户名密码信息与收到的Challenge信息进行计算，并将计算结果以加密的形式附加到下一个REGISTER请求上，重新发起注册，FreeSWITCH收到后对本地数据库中保存的Alice的信息使用同样的算法进行计算和加密，并将其与Alice发过来的计算结果想比较。如果计算结果匹配，则认证通过，Alice便可以正常注册。</p> <h3 id="sip呼叫流程"><a href="#sip呼叫流程" class="header-anchor">#</a> SIP呼叫流程</h3> <h4 id="ua间直接呼叫"><a href="#ua间直接呼叫" class="header-anchor">#</a> UA间直接呼叫</h4> <p>![image-20220302174435064](/Users/mac/Library/Application Support/typora-user-images/image-20220302174435064.png)</p> <p>状态码由三位数字组成，与HTTP类似：</p> <ul><li>1xx:响应为临时状态。</li> <li>2xx:请求已被成功收到、理解和接受。</li> <li>3xx:重定向。</li> <li>4xx:请求失败，客户端或网络引起。</li> <li>5xx:服务器内部错误。</li> <li>6xx:全局性错误。</li></ul> <h4 id="通过b2bua呼叫"><a href="#通过b2bua呼叫" class="header-anchor">#</a> 通过B2BUA呼叫</h4> <p>![image-20220302174916707](/Users/mac/Library/Application Support/typora-user-images/image-20220302174916707.png)</p> <h3 id="深入理解sip"><a href="#深入理解sip" class="header-anchor">#</a> 深入理解SIP</h3> <h4 id="sip-uri"><a href="#sip-uri" class="header-anchor">#</a> SIP URI</h4> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>sip:Alice@192.168.1.20
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>192.168.1.9是FreeSWITCH服务器，Bob和Alice在另外机器上，Bob呼叫Alice，Bob使用使用服务器地址，
FreeSWITCH接到请求后，查找本地数据库，找到Alice实际地址，建立呼叫。</p> <h4 id="sdp和soa"><a href="#sdp和soa" class="header-anchor">#</a> SDP和SOA</h4> <p>SIP负责建立和释放会话，一般来说，会话包含相关的媒体，如视频和音频。媒体数据是由SDP（SessionDescription Protocol，会话描述协议）描述的。</p> <p>SDP一般不单独使用，它与SIP配合使用时会放在SIP协议正文（Body）中。</p> <p>媒体流的协商过程称为SOA（Service Offer and Answer，协议/应答）。</p> <h4 id="_3pcc"><a href="#_3pcc" class="header-anchor">#</a> 3PCC</h4> <p>3PCC（Third Party Call Control，第三方电话呼叫控制）指得是由第三方控制者（Controller）在另外两者之间建立的一个会话，由控制者负责会话双方的媒体协商。在3PCC中可能没有SDP。</p> <h4 id="sip承载"><a href="#sip承载" class="header-anchor">#</a> SIP承载</h4> <p>HTTP是用TCP承载的，而SIP则支持TCP和UDP承载。常用的SIP都是用UDP承载的。</p> <p>需要对SIP加密的情况，可以使用TLS。TLS是基于TCP的。</p> <h2 id="媒体-2"><a href="#媒体-2" class="header-anchor">#</a> 媒体</h2> <h3 id="媒体与媒体处理"><a href="#媒体与媒体处理" class="header-anchor">#</a> 媒体与媒体处理</h3> <h4 id="音频编码"><a href="#音频编码" class="header-anchor">#</a> 音频编码</h4> <p>从模拟信号变成数字信号的过程称为模数转换（Analog Digital Conver，AD）。AD转换要经过采样、量化、编码三个过程。</p> <ol><li><p>PCM编码，又称G.711编码</p> <p>使用PCM方式对原始声音信号进行采样、量化后得到线性编码，然后再进行压缩，这种编码方式称为PCM编码。PCM的两种压缩方式A率和μ率对应的编码名称分别为PCMA和PCMU。</p></li> <li><p>FreeSWITCH支持的其他语言编码</p> <p>FreeSWITCH支持非常丰富的语音编码。</p></li> <li><p>FreeSWITCH中与编码相关的主要命令</p> <p>控制台使用<code>show codec</code>命令，可以查看FreeSWITCH支持的编码类型。</p></li></ol> <h4 id="媒体工作机理和相关配置"><a href="#媒体工作机理和相关配置" class="header-anchor">#</a> 媒体工作机理和相关配置</h4> <ol><li><p>工作机理</p> <p>在基于SIP的通信中，媒体数据是在RTP流中传输的。</p> <p>RTP包使用与SIP不同的UDP端口传送，因而在实际传输前需要先通过SIP信令与对方“协商”好往哪个端口传送。</p> <p>RTP数据一般只使用UDP承载。</p></li> <li><p>相关配置</p> <p>SIP Profile支持的媒体列表是在vars.xml文件中配置的。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>X-PRE-PROCESS</span> <span class="token attr-name">cmd</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>global_codec_prefs=G722,PCMU,PCMA,GSM<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>X-PRE-PROCESS</span> <span class="token attr-name">cmd</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>outound_codec_prefs=PCMU,PCMA,GSM<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ol> <h3 id="媒体协商"><a href="#媒体协商" class="header-anchor">#</a> 媒体协商</h3> <h4 id="协商过程"><a href="#协商过程" class="header-anchor">#</a> 协商过程</h4> <p>打一个电话，如果客户端与服务端提供的编码没有交集，FreeSWITCH会返回SIP 488消息。</p> <p>SIP采用Offer/Answer(请求/应答)机制来协商。请求发起的一方提供自己的编码列表，被请求的一方比较自己支持的媒体列表最终选择一种编码，
以应答方式通知请求者，然后就可以使用兼容的编码进行通信了。</p> <h4 id="sdp以及在编码协商中的作用"><a href="#sdp以及在编码协商中的作用" class="header-anchor">#</a> SDP以及在编码协商中的作用</h4> <p>媒体类型是由SDP消息描述的。</p> <h4 id="协商时机与策略"><a href="#协商时机与策略" class="header-anchor">#</a> 协商时机与策略</h4> <p>协商可分为早协商和晚协商。当呼叫到达一个SIP Profile时，即某端收到INVITE请求而未到达路由阶段时，就先行协商，称为早协商。而等到路由阶段，到达拨号阶段再进行协商的，称为晚协商。</p> <p>系统默认为晚协商。</p> <p>FreeSWITCH支持如下协商策略：generous、greedy和scrooge。</p> <ul><li>generous：优先考虑客户端。</li> <li>greedy：优先考虑服务端的编码。</li> <li>scrooge：除了greedy还强制使用自己的采样率。</li></ul> <h3 id="其他媒体相关的问题"><a href="#其他媒体相关的问题" class="header-anchor">#</a> 其他媒体相关的问题</h3> <h4 id="rtp和rtcp"><a href="#rtp和rtcp" class="header-anchor">#</a> RTP和RTCP</h4> <p>在完成SIP及SDP协商后，真正的语音数据是在RTP协议中传送的。</p> <p>RTP协议的全称是Real-time Transport Protocol，即及时传输协议。</p> <p>实时传输控制协议（Real-time Transfer Control Protocol或 RTP Control Protocol，RTCP）是实时传输协议的一个姐妹协议。</p> <p>RTCP为RTP流媒体提供信道外的控制，本省不传输数据。</p> <h4 id="转码"><a href="#转码" class="header-anchor">#</a> 转码</h4> <p>FreeSWITCH是一个B2BUA，因而在桥接两条腿时，如果两条腿分别使用不同的编码，则需要经过一个转码过程分别转换成对方需要的编码</p> <p>需要转码时，会将收到的音频数据转换成一直中间格式，称为L16。</p> <h4 id="透传、媒体绕过与媒体代理"><a href="#透传、媒体绕过与媒体代理" class="header-anchor">#</a> 透传、媒体绕过与媒体代理</h4> <ul><li>透传：不经过转码的情况下，将从一方收到的流媒体原样传送给另一方。</li> <li>媒体绕过：真正的媒体流使用点到点传输，根本不经过FreeSWITCH。</li> <li>媒体代理：对RTP数据不在进行任何处理发给另一方，只改变SDP中的“c=”部分。</li></ul> <h4 id="media-bug"><a href="#media-bug" class="header-anchor">#</a> Media Bug</h4> <p>为了解决监听和录音问题，FreeSWITCH在媒体流路径上放了一个Media Bug。相当于水管上的一个三通。</p> <h4 id="视频"><a href="#视频" class="header-anchor">#</a> 视频</h4> <p>FreeSWITCH还不支持视频编码解码，所有的视频流都是透传的。</p> <h4 id="排错"><a href="#排错" class="header-anchor">#</a> 排错</h4> <p>Log、装包工具、uuid_debug_media。</p> <h2 id="sip模块"><a href="#sip模块" class="header-anchor">#</a> SIP模块</h2> <h3 id="基本概念"><a href="#基本概念" class="header-anchor">#</a> 基本概念</h3> <ul><li>Sofia-SIP</li> <li>Endpoint</li> <li>mod_sofia</li> <li>SIP Profile</li> <li>Gateway</li> <li>本地SIP用户</li> <li>来话和去话</li> <li>中继来话或中继去话</li></ul> <h3 id="sofia配置文件"><a href="#sofia配置文件" class="header-anchor">#</a> Sofia配置文件</h3> <p>Sofia的配置文件是<code>conf/autoload_configs/sofia.conf.xml</code>，不过一般不修改，大部分的配置参数
实际上述文件中使用下面的预处理指令装入<code>conf/sip_profiles</code>目录中的XML中的配置。</p> <p>Sofia支持多个Profile，每个Profile相当于一个SIP UA。</p> <p>inernal和external最大的区别就是一个运行在5060端口，另一个运行在5080端口上。</p> <h4 id="profile配置文件"><a href="#profile配置文件" class="header-anchor">#</a> Profile配置文件</h4> <p>Profile中具有大量的配置参数，这些参数与具体的部署方式和呼叫流程有关。</p> <h4 id="profile的几个重要参数"><a href="#profile的几个重要参数" class="header-anchor">#</a> Profile的几个重要参数</h4> <p>Sofia的Profile有很多可配置参数，它们可以影响某一Profile所代表的SIP UA的行为。</p> <p>inbound-bypass-media用于设置入局呼叫是否启用“媒体绕过（Bypass Media）”模式</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>inbound-bypass-media<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="external-xml"><a href="#external-xml" class="header-anchor">#</a> external.xml</h4> <p>internal.xml与external.xml区别是internal使用的是5060端口，external使用的是5080端口。客户端往
5060端口发消息需要鉴权。而5080不需要。</p> <h4 id="gateway"><a href="#gateway" class="header-anchor">#</a> Gateway</h4> <p>FreeSWITCH需要通过外部网关向外打电话，而这个外部网关就称为Gateway。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>gateways</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>X-PRE-PROCESS</span> <span class="token attr-name">cmd</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>include<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>external/*.xml<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>gateways</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>gateway</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>gwl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>realm<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>SIP服务器地址<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>SIP用户名<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>密码<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>gateway</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="常用命令"><a href="#常用命令" class="header-anchor">#</a> 常用命令</h3> <p>mod_sofia提供了一个API命令–sofia。</p> <h4 id="状态相关命令"><a href="#状态相关命令" class="header-anchor">#</a> 状态相关命令</h4> <ul><li><p>列出某个Profile的状态</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>freeswitch&gt; sofia status profile internal
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>列出某个Profile上所有已注册用户。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>freeswitch&gt; sofia status profile internal reg
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>过滤某些符合条件的用户</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>freeswitch&gt; sofia status profile internal reg 1000
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>列出某个特定用户</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>freeswitch&gt; sofia status profile internal user 1000
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>列出网关状态</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>freeswitch&gt; sofia status gateway gwl
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul> <h4 id="profile相关命令"><a href="#profile相关命令" class="header-anchor">#</a> Profile相关命令</h4> <p>Profile相关的命令都是针对Profile进行的操作。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>freeswitch<span class="token operator">&gt;</span> sofia profile internal start        <span class="token comment"># 启动</span>
freeswitch<span class="token operator">&gt;</span> sofia profile internal stop     <span class="token comment"># 停止</span>
freeswitch<span class="token operator">&gt;</span> sofia profile internal restart  <span class="token comment"># 重启</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>重读sofia的配置（不是所有配置参数都能生效）</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>freeswitch<span class="token operator">&gt;</span> sofia profile internal rescan 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="sip-capture"><a href="#sip-capture" class="header-anchor">#</a> SIP Capture</h4> <p>FreeSWITCH内置了Homer Capture Agent用于SIP抓包。</p> <p>使用Capture功能前，需要在sofia.conf.xml中配置Capture Node的地址。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>capture-server<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>udp:192.168.0.100:6060<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="global相关"><a href="#global相关" class="header-anchor">#</a> global相关</h4> <p>打开和关闭全局SIP消息跟踪</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>freeswitch<span class="token operator">&gt;</span> sofia global siptrace on
freeswitch<span class="token operator">&gt;</span> sofia global siptrace off
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>打开和关闭全局SIP捕获（Homer方式抓包）</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>freeswitch&gt; sofia global capture on
freeswitch&gt; sofia global capture off
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="debug相关"><a href="#debug相关" class="header-anchor">#</a> debug相关</h4> <p>更低级别调试器</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>freeswitch<span class="token operator">&gt;</span> sofia loglevel all <span class="token number">9</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="其他命令"><a href="#其他命令" class="header-anchor">#</a> 其他命令</h4> <ul><li>sofia_username_of。返回注册用户的username。</li> <li>sofia_contact。返回注册用户的联系地址。</li> <li>sofia_count_reg。计算有多少客户端注册了。</li> <li>sofia_dig。返回其他服务器地址和端口。</li> <li>sofia_presence_data。显示Presence数据。</li></ul> <h4 id="其他-2"><a href="#其他-2" class="header-anchor">#</a> 其他</h4> <p>修改Profile参数需要重启，能不重启就不重启，但IP地址相关的参数和端口，一般需要重启。</p> <h3 id="nat穿越"><a href="#nat穿越" class="header-anchor">#</a> NAT穿越</h3> <p>适当地解决在NAT网络环境下的内、外网通信问题，就称为NAT穿越。</p> <h4 id="nat的种类"><a href="#nat的种类" class="header-anchor">#</a> NAT的种类</h4> <p>NAT有三种类型：静态NAT（Static NAT）、动态NAT（Pooled NAT）和网络地址端口转换
（Network Address Port Translation，NAPT）。</p> <p>NAPT有四种类型</p> <ol><li><p>Full Cone NAT（全锥型NAT）</p> <p>内部主机向外打一个洞，外网的任何主机都可以利用这个洞与它通信。</p></li> <li><p>Restricted Cone NAT（限制锥型NAT）</p> <p>内部主机向外某一外部主机打一个洞后，只有该外部主机才能利用这个洞。</p></li> <li><p>Port Restricted Cone NAT（端口限制锥型NAT）</p> <p>内部主机向外部主机上某一程序（一个端口）打了一个洞，只有该程序可以利用这个洞。</p></li> <li><p>Symmetric NAT（对称型NAT）</p> <p>对称型NAT相当于对同一内部主机联系不同外部主机时都需要打不同的洞。</p></li></ol> <h4 id="freeswitch的拓扑结构"><a href="#freeswitch的拓扑结构" class="header-anchor">#</a> FreeSWITCH的拓扑结构</h4> <p>FreeSWITCH一般有三种拓扑结构。</p> <p>客户端A–NAT–Internet–FreeSWITCH–外部网关
客户端A–FreeSWITCH–NAT–Internet–外部网关
客户端A–FreeSWITCH–NAT–Internet–外部网关（其中Internet有分支 客户端B–Internet–NAT–客户端C ）</p> <h4 id="nat是怎样影响sip-rtp通信的"><a href="#nat是怎样影响sip-rtp通信的" class="header-anchor">#</a> NAT是怎样影响SIP/RTP通信的</h4> <p>解决NAT问题通常2种思路：</p> <ul><li>如果FreeSWITCH足够聪明，那么它会记住外网地址。</li> <li>可以从客户端解决。靠STUN服务解决。</li></ul> <h4 id="nat的穿越方法"><a href="#nat的穿越方法" class="header-anchor">#</a> NAT的穿越方法</h4> <p>解决NAT穿越问题前，先做如下准备：</p> <ul><li>了解你的网络环境和拓扑结构。</li> <li>禁用路由器的ALG（Application Level Gateway）。</li></ul> <h2 id="基本技能"><a href="#基本技能" class="header-anchor">#</a> 基本技能</h2> <h3 id="调试与排错"><a href="#调试与排错" class="header-anchor">#</a> 调试与排错</h3> <h4 id="解决问题的一般方法和流程"><a href="#解决问题的一般方法和流程" class="header-anchor">#</a> 解决问题的一般方法和流程</h4> <p>发现问题、定位问题、分析问题、解决问题。</p> <ul><li>核实问题的现象。</li> <li>问题能否重现。</li></ul> <h4 id="查看日志"><a href="#查看日志" class="header-anchor">#</a> 查看日志</h4> <p>分断调试，查看日志。</p> <h3 id="使用外部工具包"><a href="#使用外部工具包" class="header-anchor">#</a> 使用外部工具包</h3> <h4 id="tcpdump"><a href="#tcpdump" class="header-anchor">#</a> tcpdump</h4> <p>tcpdump是经典的抓包工具。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># tcpdump -np -s 0 -A -vvv eth0 port 5060</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="tshark"><a href="#tshark" class="header-anchor">#</a> tshark</h4> <p>tshark是Wireshark的命令行版。使用方法与tcpdump类似。</p> <h4 id="ngrep"><a href="#ngrep" class="header-anchor">#</a> ngrep</h4> <p>ngrep也是一个非常好用的抓包工具（类似与经典的UNIX命令行工具grep）。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code># ngrep -p -q -W byline port 5060
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="pcapsipdump"><a href="#pcapsipdump" class="header-anchor">#</a> pcapsipdump</h4> <p>pcapsipdump能将不同通话IP包存到不同的文件里，有大量通话的时候比较好用。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>pcapsipdump -i eth0 -d /tmp/sipdump/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="使用wireshark抓包并分析呼叫"><a href="#使用wireshark抓包并分析呼叫" class="header-anchor">#</a> 使用Wireshark抓包并分析呼叫</h3> <h4 id="使用wireshark抓包"><a href="#使用wireshark抓包" class="header-anchor">#</a> 使用Wireshark抓包</h4> <p>图形界面的抓包工具Wireshark。</p> <h4 id="使用wireshark对抓包进行分析"><a href="#使用wireshark对抓包进行分析" class="header-anchor">#</a> 使用Wireshark对抓包进行分析</h4> <ul><li>分析SIP包</li> <li>分析RTP包</li></ul> <h3 id="originate命令实例解析"><a href="#originate命令实例解析" class="header-anchor">#</a> originate命令实例解析</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>_USAGE:<span class="token operator">&lt;</span>call url<span class="token operator">&gt;</span><span class="token operator">&lt;</span>exten<span class="token operator">&gt;|</span><span class="token operator">&amp;</span><span class="token operator">&lt;</span>application_name<span class="token operator">&gt;</span><span class="token punctuation">(</span>app_sec<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>dialplan<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>context<span class="token operator">&gt;</span><span class="token punctuation">[</span>cid_name<span class="token punctuation">]</span><span class="token punctuation">[</span>cid_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>timeout_sec<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="使用格式和参数"><a href="#使用格式和参数" class="header-anchor">#</a> 使用格式和参数</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>freeswitch<span class="token operator">&gt;</span> originate user/1000 <span class="token operator">&amp;</span><span class="token builtin class-name">echo</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="转入dialplan"><a href="#转入dialplan" class="header-anchor">#</a> 转入Dialplan</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>freeswitch&gt; originate user/1000 1001 XML public
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="更改主叫号码"><a href="#更改主叫号码" class="header-anchor">#</a> 更改主叫号码</h4> <p>主叫名称（cid_name，Caller ID Name）和主叫号码（cid_number，Caller ID Number）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>freeswitch&gt; originate user/1000 &amp;echo XML default 'Seven Du' 7777
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="处理呼叫超时"><a href="#处理呼叫超时" class="header-anchor">#</a> 处理呼叫超时</h4> <p>最后一个参数是超时的秒数。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>freeswitch&gt; originate sofia/internal/1000@192.168.100.100 &amp;ehco XML default 'Seven Du' 7777 10
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="防止命令阻塞"><a href="#防止命令阻塞" class="header-anchor">#</a> 防止命令阻塞</h4> <p>解决阻塞：</p> <ul><li>使用bgapi。</li> <li>开启另外一个fs_cli客户端。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>freeswitch&gt; bgapi originate user/1000 &amp;echo 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="使用通道变量"><a href="#使用通道变量" class="header-anchor">#</a> 使用通道变量</h4> <p>通道变量可以影响呼叫行为。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>freeswitch&gt; originate {originate_call_id_name='Seven Du',origination_caller_id_number=7777}user/1000 &amp;echo 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="early-media对呼叫的影响"><a href="#early-media对呼叫的影响" class="header-anchor">#</a> Early Media对呼叫的影响</h4> <p>有些Early Media对我们没有意义，如我们主动外呼的应用，可以指定ignore_earlly_media变量，忽略对方返回的
Early Media。</p> <h4 id="bridge也使用originate"><a href="#bridge也使用originate" class="header-anchor">#</a> bridge也使用originate</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>freeswitch&gt; originate user/1000 &amp;bridge(user/1000)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="brige中的early-media"><a href="#brige中的early-media" class="header-anchor">#</a> brige中的Early Media</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>freeswitch&gt; originate {transfer_ringback=local_stream://moh}user/1000 &amp;bridge(user/1001)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="bridge中的主叫号码"><a href="#bridge中的主叫号码" class="header-anchor">#</a> bridge中的主叫号码</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>freeswitch&gt; originate {originate_caller_id_number=7777}user/1000 &amp;echo 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="呼叫是怎样工作的"><a href="#呼叫是怎样工作的" class="header-anchor">#</a> 呼叫是怎样工作的</h3> <p>SIP发送请求到5060端口-&gt;UAS对INVITE进行鉴权-&gt;路由-&gt;找到1001实际位置-&gt;作为UCA给1001发送请求</p> <h3 id="freeswitch图形用户界面简介"><a href="#freeswitch图形用户界面简介" class="header-anchor">#</a> FreeSWITCH图形用户界面简介</h3> <p>开发FreeSWITCH的GUI有两种方法：</p> <ul><li>通过图形界面，修改FreeSWITCH的XML配置文件，并调用reloadxml或其他重启指令。</li> <li>使用xml_curl接口，提供一个HTTP服务器动态的向FreeSWITCH提供XML。</li></ul> <h4 id="fusionpbx"><a href="#fusionpbx" class="header-anchor">#</a> FusionPBX</h4> <p>FusionPBX是使用PHP开发的FreeSWITCH GUI。通过将数据储存在数据库中，并修改本地XML配置文件。</p> <h4 id="blue-box"><a href="#blue-box" class="header-anchor">#</a> blue.box</h4> <p>2600Hz团队开发的一款开源GUI产品。</p> <h4 id="freeswitch-portal"><a href="#freeswitch-portal" class="header-anchor">#</a> FreeSWITCH Portal</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>freeswitch&gt; load_mod_xml_rpc
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>[]: http://localhost:8080/partal/	&quot;http://localhost:8080/partal/&quot;</p> <h2 id="基本功能与实现"><a href="#基本功能与实现" class="header-anchor">#</a> 基本功能与实现</h2> <h3 id="批量创建用户"><a href="#批量创建用户" class="header-anchor">#</a> 批量创建用户</h3> <ul><li><p>手工复制和替换。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># sed -e &quot;s/1000/1020&quot; 1000.xml &gt; 1020.xml</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>使用<code>script/perl</code>中的add_user脚本</p></li></ul> <h3 id="用freeswitch实现ivr"><a href="#用freeswitch实现ivr" class="header-anchor">#</a> 用FreeSWITCH实现IVR</h3> <p>IVR(Interactive Voice Response，交互式语音响应)</p> <h4 id="最简单的菜单"><a href="#最简单的菜单" class="header-anchor">#</a> 最简单的菜单</h4> <p>IVR系统默认的配置文件为<code>conf/autoload_config/ivr.conf.xml</code>。</p> <p>真正的菜单配置信息放到一对“”标签中。</p> <h4 id="默认ivr简介"><a href="#默认ivr简介" class="header-anchor">#</a> 默认IVR简介</h4> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>menu-exec-app<span class="token punctuation">&quot;</span></span> <span class="token attr-name">digits</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">param</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bridge sofia/$${domain}/888@conference.freeswitch.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>menu-exec-app<span class="token punctuation">&quot;</span></span> <span class="token attr-name">digits</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">param</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transfer 9196 XML default<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>menu-exec-app<span class="token punctuation">&quot;</span></span> <span class="token attr-name">digits</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>3<span class="token punctuation">&quot;</span></span> <span class="token attr-name">param</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transfer 9664 XML default<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>menu-exec-app<span class="token punctuation">&quot;</span></span> <span class="token attr-name">digits</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>4<span class="token punctuation">&quot;</span></span> <span class="token attr-name">param</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transfer 9191 XML default<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>menu-exec-app<span class="token punctuation">&quot;</span></span> <span class="token attr-name">digits</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>5<span class="token punctuation">&quot;</span></span> <span class="token attr-name">param</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transfer 1234*256 enum<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>menu-exec-app<span class="token punctuation">&quot;</span></span> <span class="token attr-name">digits</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>6<span class="token punctuation">&quot;</span></span> <span class="token attr-name">param</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>demo_ivr_submenu<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="按时间进行路由"><a href="#按时间进行路由" class="header-anchor">#</a> 按时间进行路由</h3> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extension</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>time_base_ivr<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">wday</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2-6<span class="token punctuation">&quot;</span></span> <span class="token attr-name">hour</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>8:30-17:30<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ivr<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ivr_day<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>anti-anction</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ivr<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ivr_night<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extension</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="配置中文语音提示"><a href="#配置中文语音提示" class="header-anchor">#</a> 配置中文语音提示</h3> <h4 id="最简单的实现方案"><a href="#最简单的实现方案" class="header-anchor">#</a> 最简单的实现方案</h4> <p>默认声音文件存放在sounds目录下面，英文。</p> <p>最简单的方式就是将语音包直接替换成中午语音包。</p> <h4 id="使用sound-prefix"><a href="#使用sound-prefix" class="header-anchor">#</a> 使用sound prefix</h4> <p>使用sound_prefix变量定义声音文件的具体路径</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>X-PRE-PROCESS</span> <span class="token attr-name">cmd</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sound_prefix=$${sounds_dir}/en/us/callie<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="使用phrase"><a href="#使用phrase" class="header-anchor">#</a> 使用Phrase</h4> <ol><li><p>认识Phrase</p> <p>为了屏蔽各种不同语言提示的差异性，FreeSWITCH实现了Phrase(短语)框架。</p></li> <li><p>中文支持Phrase配置</p> <p>中文与英文的配置大同小异，将英文复制一份，并在此基础上进行修改。</p></li> <li><p>“说”中文</p> <p>可以通过一些预先录制的声音文件“说”出一些常用的词语组合。</p></li> <li><p>使用中文语音提示</p> <p>准备就绪后，再Dialplan中指定language或default_language通道变量。</p></li></ol> <h3 id="录音"><a href="#录音" class="header-anchor">#</a> 录音</h3> <h4 id="单腿录音"><a href="#单腿录音" class="header-anchor">#</a> 单腿录音</h4> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>originate user/1000 &amp;record(/tmp/welcome.wav)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extension</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>record<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>destination_number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^rec(.*)$<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>answer<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>playback<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tone_stream://%(100,1000,800)<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>record<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/tmp/$1.wav<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extension</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="对两条腿的通话进行录音"><a href="#对两条腿的通话进行录音" class="header-anchor">#</a> 对两条腿的通话进行录音</h4> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>uuid_record <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>channel_uuid</span><span class="token punctuation">&gt;</span></span> start /tmp/record.wav
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>该录音文件包含两个声道。</p> <p>可以使用sox命令进行混音：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>$ sox record.wav -c 1 record-1.wav
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在Dialplan中，可以通过record_session达到类似的效果：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extension</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>record<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>destination_number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>^(100[0-9])$<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>record_session<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/tmp/record-$1.wav<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bridge<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>user/$1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extension</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>record_session是一个APP，非阻塞。</p> <h4 id="立体声"><a href="#立体声" class="header-anchor">#</a> 立体声</h4> <p>通过事先将RECORD_STEREO通道变量设置为true可以在录音时直接录成立体声。</p> <h4 id="录音相关的通道变量"><a href="#录音相关的通道变量" class="header-anchor">#</a> 录音相关的通道变量</h4> <ul><li>RECORD_HANGUP_ON_ERROR</li> <li>RECORD_WRITE_ONLY</li> <li>RECORD_READ_ONLY</li> <li>RECORD_STEREO</li> <li>RECORD_STEREO_SWAP</li> <li>RECORD_ANSWER_REQ</li> <li>RECORD_BRIDGE_REQ</li> <li>RECORD_APPEND</li> <li>RECORD_SAMPLE_RATE</li> <li>ENABLE_FILE_WRITE_BUFFERING</li> <li>RECORD_MIN_SEC</li> <li>RECORD_INITIAL_TIMEOUT_MS</li> <li>RECORD_FINAL_TIMEOUT_MS</li> <li>RECORD_SILENCE_THRESHOLD</li></ul> <h4 id="原生格式"><a href="#原生格式" class="header-anchor">#</a> 原生格式</h4> <p>为了最大限度地节省系统资源，可以将声音录制成原生（Native）格式。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>freeswitch<span class="token operator">&gt;</span> originate user/1000 <span class="token operator">&amp;</span>record<span class="token punctuation">(</span>/tmp/test<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会将录音录成<code>/tmp/test.PCMU</code></p> <p>可以使用sox软件中的play命令播放</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>play -e u-law -r <span class="token number">8000</span> -t raw test-in.PCMU
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="放音"><a href="#放音" class="header-anchor">#</a> 放音</h3> <h4 id="playback的参数"><a href="#playback的参数" class="header-anchor">#</a> playback的参数</h4> <ol><li><p>声音文件</p> <p>大部分声音文件的支持都在mod_sndfile模块中实现的。典型的如WAV、AU、AIFF、VOX等。</p></li> <li><p>local_stream</p> <p>local_stream是在mod_local_stream中实现的。</p></li> <li><p>silence_stream</p> <p>silence_stream是一个静音流。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>playback<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>silence_stream://2000,1400<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ol> <p>​			1400为舒适噪音的参数值。</p> <ol start="4"><li><p>tone_stream</p> <p>tone_stream是一个铃流，它在mod_tone_stream模块中实现。</p> <p>我国的回铃音信号为450Hz的信号音，1秒通，4秒断。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>playback<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tone_stream://%(1000,4000,450)<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>file_string</p> <p>可以将多个文件串联起来，放在同一个playback命令中播放。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>playback<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file_string:///tmp/file1.wav!tmp/file2.wav!/tmp/file3.wav<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ol> <h4 id="循环播放"><a href="#循环播放" class="header-anchor">#</a> 循环播放</h4> <p>不断播放test.wav直至挂机的实现如下：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>endless_playback<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>temp/test.wav<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="say"><a href="#say" class="header-anchor">#</a> Say</h4> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>say<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en number iterated 1234<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="tts"><a href="#tts" class="header-anchor">#</a> TTS</h3> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>TTS(Text To Speech)是将文本转换成语音的一项技术，因而又称为语音合成（Synthesis）。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="使用mod-flite"><a href="#使用mod-flite" class="header-anchor">#</a> 使用mod_flite</h4> <p>mod_file是基于Flite语音合成引擎的一个TTS模块。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>originate user/1000 &amp;speak('flite|kal|Hello,Welcome to FreeSWITCH')
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="mod-tts-commandline"><a href="#mod-tts-commandline" class="header-anchor">#</a> mod_tts_commandline</h4> <p>可以使用命令来执行TTS功能。mod_tts_commandline模块可以调用这些命令，生成一个文件，进而
播放这个声音文件，从而达到其他TTS软件执行TTS功能的目的。</p> <h4 id="mrcp"><a href="#mrcp" class="header-anchor">#</a> MRCP</h4> <p>MRCP（Media Resource Control Protocl）是一个支持访问网络上的媒体资源的协议。
它的典型应用就是TTS和ASR（自动语音识别）。</p> <h4 id="google-translate"><a href="#google-translate" class="header-anchor">#</a> Google Translate</h4> <p>Google Translate（谷歌翻译）</p> <h3 id="在呼叫失败的情况下向主叫用户播放语音提示"><a href="#在呼叫失败的情况下向主叫用户播放语音提示" class="header-anchor">#</a> 在呼叫失败的情况下向主叫用户播放语音提示</h3> <h4 id="实现方法"><a href="#实现方法" class="header-anchor">#</a> 实现方法</h4> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bridge<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>user/${dialed_extension}@${domain_name}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>answer<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sleep<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1000<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bridge<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>loopback/app=voicemail:default ${domain_name} ${dialed_extension}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="进阶"><a href="#进阶" class="header-anchor">#</a> 进阶</h4> <ul><li>使用Lua脚本,使用if..then..else之类的逻辑选择播放声音，其他一律播放同一个文件。</li> <li>使用Dialplan配置</li></ul> <h4 id="使用tts"><a href="#使用tts" class="header-anchor">#</a> 使用TTS</h4> <p>使用Phrase Macro功能实现各种提示</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>macro</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>USER_BUSY<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>macro</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>macro</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>USER_NOT_REGISTERED<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>macro</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h4> <p>在被叫失败后播放我们上面指定的提示音或TTS是有一个前提的，在Dialplan的第一个bridge要有以下两行</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hangup_after_bridge=true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>set<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>continue_on_fail=true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="实现呼叫前转业务"><a href="#实现呼叫前转业务" class="header-anchor">#</a> 实现呼叫前转业务</h3> <p>通过拨打一个特定功能码登记预转移到的电话号码，以后所有呼叫都会转移到该号码上。</p></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/dong-jianbin/docment/edit/master/docs/01.freeswitch/50.呼叫中心/00.FreeSWITCH学习.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/07/26, 06:11:07</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/38b644/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Linux安装postgresql</div></a> <a href="/pages/c3da99/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">项目架构</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/38b644/" class="prev">Linux安装postgresql</a></span> <span class="next"><a href="/pages/c3da99/">项目架构</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/866652/"><div>
            HDFS
            <!----></div></a> <span class="date">05-15</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/81241e/"><div>
            入门
            <!----></div></a> <span class="date">05-13</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/8ffda2/"><div>
            devops
            <!----></div></a> <span class="date">05-07</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:416355221@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/dong-jianbin" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2022
    <span>Dong jianbin | <a href="https://github.com/dong-jianbin/docment/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><span class="close-but">×</span> <div><!-- 固定160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;max-width:160px;max-height:160px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.6d4d842b.js" defer></script><script src="/assets/js/2.0fd9f73a.js" defer></script><script src="/assets/js/15.fbc57fc3.js" defer></script>
  </body>
</html>
