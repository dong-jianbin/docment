---
title: 传统部署
date: 2022-05-07 14:59:19
permalink: /pages/30e09c/
categories:
  - 项目
  - 部署
tags:
  - 
---

## 后台系统

### 本地开发测试

#### 开发工具

1. 集成开发工具IntellJ IDE

   官网https://www.jetbrains.com/idea/下载最新版本

   > 使用新版本，享受最新功能。通过插件【IDE Eval Reset】破解，方便快捷。步骤如下：

   - 添加插件仓库

     首先打开idea，点击菜单File -> Settings.. -> Plugins，然后添加第三方插件仓库的ip：**https://plugins.zhile.io**，操作如下图所示

     ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220421110129.png)

   - 搜索下载插件

     然后在Marketplace中搜索IDE Eval Reset，点击Install安装

     ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220421111334.png)

   - 重启idea，插件生效

     最后重启idea，进行reset即可。Reset时 点击会询问是否重置试用信息并重启 IDE。选择 Yes 则执行重置操作并重启 IDE 生效，选择 No 则什么也不做

     > idea每次重启时，会自动reset，原理就是重新reset试用期。若超过idea试用的天数（25天）没有重启idea，则会提示idea已到期。方法是重启idea，或者在这之前手动reset试用期

     ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220421111246.png)

2. 分布式版本控制工具git

   - https://git-scm.com/ 官网下载相应系统版本

   - 安装git

     ```shell
     # 搜索git
     brew search git
     
     # 安装git
     brew install git
     
     # 更新git
     brew upgrade git
     
     # 卸载git
     brew uninstall git
     ```

3. 项目构建工具maven

   - 下载maven安装包

     ```shell
     wget https://archive.apache.org/dist/maven/maven-3/3.3.9/binaries/apache-maven-3.3.9-bin.tar.gz
     ```

   - 解压缩maven

     ```shell
     tar -zxvf apache-maven-3.3.9-bin.tar.gz
     ```

   - 配置maven环境变量

     ```shell
     export MAVEN_HOME=/var/local/apache-maven-3.5.2
     export MAVEN_HOME
     export PATH=P A T H : PATH:PATH:MAVEN_HOME/bin
     ```

   - 验证结果

     ```
     mvn -version
     ```

4. jdk开发包

   - 官网下载jdk https://www.oracle.com/java/technologies/downloads/#java8-linux

   - 解压jdk

     ```shell
     tar -xvf jdk-8u331-linux-x64.tar.gz
     ```

   - 环境设置

     ```shell
     export JAVA_HOME=/home/dongjb/soft/jdkexport CLASSPATH=.:${JAVA_HOME}/jre/lib/rt.jar:${JAVA_HOME}/lib/dt.jar:${JAVA_HOME}/lib/tools.jar
     export PATH=$PATH:${JAVA_HOME}/bin
     ```

#### 运行环境

1. 数据库mysql

   - repo配置

     ```shell
     wget https://dev.mysql.com/get/mysql57-community-release-el7-9.noarch.rpm
     rpm -ivh mysql57-community-release-el7-9.noarch.rpm
     ```

   - 安装服务

     ```shell
     yum install mysql-server
     ```

     >注意：
     >
     >mysql-community-libs-compat-5.7.37-1.el7.x86_64.rpm 的公钥尚未安装
     >
     >失败的软件包是：mysql-community-libs-compat-5.7.37-1.el7.x86_64
     >GPG  密钥配置为：file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql
     >解决办法：
     >
     >```shell
     >rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2022
     >```

   - 启动

     ```shell
     systemctl start mysqld
     systemctl enable mysqld 
     ```

   - 初始密码

     ```shell
     grep 'temporary password' /var/log/mysqld.log
     ```

   - 用初始密码登陆

     ```shell
     mysql -uroot -p
     ```

   - 修改密码

     ```sql
     set global validate_password_policy=LOW; 
     set global validate_password_length=6;
     ALTER USER 'root'@'localhost' IDENTIFIED BY '123456'; 
     ```

   - 远程控制

     ```sql
     grant all privileges on *.* to root@"localhost" identified by "123456";
     
     use mysql;
     update user set Host='%' where User='root';
     #刷新权限相关表
     FLUSH PRIVILEGES;
     ```

     #远程连接就ok了

     mysql -h192.168.203.21 -uroot -p123456

   - 表明大小写不敏感

     ```shell
     #vi /etc/my.cnf
     lower_case_table_names=1
     ```

   - 重启服务

     ```
     systemctl restart mysqld
     ```

   - 关闭防火墙,其他机器不能访问

     ```shell
     #关闭防火墙：
     systemctl stop firewalld.service
     #开启防火墙：
     systemctl start firewalld.service
     #关闭开机启动： 
     systemctl disable firewalld.service
     #开启开机启动： 
     systemctl enable firewalld.service
     #状态查看
     systemctl status firewalld.service
     ```

   - 创建用户，授权，建库

     ```sql
     set global validate_password_policy=LOW; 
     set global validate_password_length=6;
     
     CREATE USER 'road_monitoring'@'%' IDENTIFIED BY 'road@2020';
     CREATE USER 'rdsss'@'%' IDENTIFIED BY '123456';
     
     GRANT ALL PRIVILEGES ON *.* TO 'road_monitoring'@'%';
     GRANT ALL PRIVILEGES ON *.* TO 'rdsss'@'%';
     
     show grants for 'road_monitoring'@'%';
     show grants for 'rdsss'@'%';
     
     create database road_monitoring;
     create database springcloud_ai_db2;
     create database springcloud_ai_db3;
     
     #数据导出
     navicat -> 工具 -> 数据传输 —>目标选择文件
     #倒数据入
     mysql -h192.168.203.21 -uroot -p123456
     use road_monitoring
     source road.sql
     ```

2. 缓存redis

   - 依赖更新,需要c编译

     ```shell
     yum install -y gcc
     ```

   - 下载

     ```shell
     wget http://download.redis.io/releases/redis-5.0.3.tar.gz
     ```

   - 解压

     ```shell
     tar -xvf redis-5.0.3.tar.gz
     ```

   - 编译

     ```shell
     cd redis-5.0.3
     make MALLOC=libc
     make install PREFIX=/home/pcqms/redis
     ```

   - 修改配置

     ```shell
     cp redis.conf /home/pcqms/redis/bin
     # vi redis.conf
     # 修改成后台启动 daemonize yes
     # 保护模式去掉 protected-mode no
     # 远程访问 注释bind 127.0.0.1
     # 修改端口(6379在用，redis配置中心对应修改) 6379 -> 6389
     # 修改密码 requirepass JF0wS76J
     ```

   - 开机启动

     ```shell
     #vi /etc/systemd/system/redis.service
     [Unit]
     Description=redis-server
     After=network.target
     
     [Service]
     Type=forking
     ExecStart=/home/pcqms/redis/bin/redis-server /home/pcqms/redis/bin/redis.conf
     PrivateTmp=true
     
     [Install]
     WantedBy=multi-user.target
     ```

   - 服务启动

     ```shell
     systemctl daemon-reload
     systemctl start redis.service
     systemctl enable redis.service
     systemctl restart redis.service
     systemctl disable redis.service
     
     #当前用户手工启动
     cd /home/pcqms/redis/bin
     redis-server redis.conf
     ```

   - 连接测试

     ```
     redis-cli -h 192.168.203.20 -p 6389 -a JF0wS76J
     或者
     redis-cli -h 192.168.203.20 -p 6389
     auth JF0wS76J
     ```

3. 消息kafka

   > ##### kafka 是[Scala](https://so.csdn.net/so/search?q=Scala&spm=1001.2101.3001.7020) 语言开发，运行在 jvm 上.确定已经安装了jdk

   - 官网 https://kafka.apache.org/

   - 安装 zookeeper

     ```shell
     # 下载
     wget https://dlcdn.apache.org/zookeeper/zookeeper-3.7.0/apache-zookeeper-3.7.0-bin.tar.gz
     
     # 解压文件
     tar -xvf apache-zookeeper-3.7.0-bin.tar.gz
     
     # 复制一份配置文件, 方便修改
     cp conf/zoo_sample.cfg conf/zoo.cfg
     
     # 启动
     bin/zkServer.sh start
     
     # 连接控制台
     bin/zkCli.sh 
     
     # 查看zk的根目录相关节点
     ls /
     ```

   - 安装 kafka

     ```shell
     #下载
     wget https://dlcdn.apache.org/kafka/3.1.0/kafka_2.12-3.1.0.tgz
     
     # 解压 kafka 
     tar -xvf kafka_2.12-3.1.0.tgz
     
     # 修改配置文件 
     vi config/server.properties
     
     # broker.id属性在kafka集群中必须要是唯一
     broker.id=0
     # kafka部署的机器ip和提供服务的端口号,切勿设0.0.0.0可能报错
     listeners=PLAINTEXT://192.168.203.20:9092
     # kafka的消息存储文件
     log.dir=/home/pcqms/kafka/data
     # kafka 连接 zookeeper 的地址
     zookeeper.connect=192.168.203.20:2181
     
     # 启动服务 , 运行的日志打印在 logs 目录里的server.log 里
     # 后台启动，不会打印日志到控制台
     2：bin/kafka-server-start.sh config/server.properties &
     nohup bin/kafka-server-start.sh config/server.properties >> kafka.log 2>&1 &
     
     # 启动成功后,可以进入zookeeper 查看kafka节点
     bin/zkCli.sh
     ls /
     
     # 停止kafka 
     bin/kafka‐server‐stop.sh
     
     ```

   - Kafka 开启远程连接

     ```shell
     vim config/server.properties
     
     # 把下述配置注释
     listeners=PLAINTEXT://:127.0.0.1:9092
     
     # 配置下述内容
     advertised.listeners=PLAINTEXT://127.0.0.1:9092
     ```

#### 项目架构

1. 系统架构图

   ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220423074741.png)

2. 框架技术栈

   | 技术             | 版本          | 说明                |
   | ---------------- | ------------- | ------------------- |
   | Spring Boot      | 2.0.3.RELEAS  | 容器+MVC框架        |
   | Spring Security  | 5.0.8.RELEASE | 认证和授权框架      |
   | Mybatis-plus     | 3.3.2         | ORM框架             |
   | MyBatisGenerator | 1.3.2         | 数据层代码生成      |
   | PageHelper       | 5.2.0         | MyBatis物理分页插件 |
   | knife4j+swagger  | 2.0.4         | 文档生产工具        |
   | ai-Kafka         | 1.1.0         | 分布式消息          |
   | ai-Redis         | 1.1.0         | 分布式缓存          |
   | Poi              | 3.9           | excel               |
   | JWT              | 0.9.0         | JWT登录支持         |
   | Lombok           | 1.18.6        | 简化对象封装工具    |
   | quartz           | 2.3.0         | 定时任务            |

3. 微服务技术栈

   | 技术    | 版本             | 说明                |
   | ------- | ---------------- | ------------------- |
   | eureka  | Finchley.RELEASE | springcloud服务发现 |
   | config  | Finchley.RELEASE | springcloud配置中心 |
   | fein    | Finchley.RELEASE | springcloud负载均衡 |
   | hystrix | Finchley.RELEASE | springcloud熔断     |

4. 项目目录

   ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220421175912.png)

   - **code-gen：代码生成模块**

     供开发人员按表快速生成相关代码的【非业务应用，无需打包、部署】

   - **common-utils： 通用工具包模块**

     包含一些通用的 http 请求封装类、时间处理工具类等

   - **ss-business： 业务服务模块**

     此模块中进行业务实现处理，里面的例子集成了 Redis 操作、动态多数据源和分库分表多数据源的使用等例子

   - **ss-jobtask： 定时任务模块**

     可实现定时任务任务类的新增配置化【配置至指定的表中】、任务的自动化管理【依赖表中任务类的配置】

   - **ss-smg_mail： 消息统一处理模块**

     实现 Kafka 消息生产、消费，以及消费监听的管理 注意：引用 common-utils 的其他模块在编译打包时需确保被引用/被依赖的 common-utils 已经编译打包了

     实现手机短信，采用阿里开发包

#### 编译运行

##### 代码获取

1. git命令行clone项目

   ```shell
   git clone ssh://zhlw_irsh@129.28.168.236:10033/home/zhlw_irsh/pcqms-service.git
   #输入git账户密码
   ```

2. 或者Idea导入项目

   - 打开idea，点击`get from vcs`

   - 输入项目的git url，要导入的目录，然后点击`clone`
   - 输入git用户密码，点击ok下载代码

   ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220421224958.png)

   

##### 编译项目

1. 打开项目

   点击`open`,打开下载的项目

2. maven仓库

   由于项目使用几个之定义的包，默认通过pom配置下载包，maven远程仓库中是不包含这些包，会报错。

   修改maven的配置，重定向到备份后的本地仓库，即指向到项目中的`lib`目录

   ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220421231137.png)

3. 编译

   刷新maven项目，编译项目，查看编译结果

   ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220421232103.png)

##### 运行应用

1. 项目配置，修改jdk成1.8版本

   ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220421232649.png)

2. 启动`服务发现`

   运行服务发现程序，并查看运行日志

   ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220423074433.png)

   `服务发现控制台`，浏览器输入url，查看已注册的应用

   ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220421234602.png)

3. 启动`配置中心`

   运行配置中心程序，并查看运行日志

   ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220422154958.png)

   `配置中心rest服务`，浏览器输入url，验证已发布的`配置内容`

   1.配置中心进程url，2.配置文件，3.配置文件内容

   ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220422155508.png)

4. 启动`业务服务模块`
   运行业务服务程序，并查看运行日志

   ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220422160601.png)

   api接口文档，业务api查看及测试

   1.输入业务逻辑进程url，2.业务api列表中选择一个功能，3.查看接口文档，并进行测试

   ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220422161210.png)

5. 启动`定时任务模块`

   1.启动项目进程，2.模块目录，3.模块配置，4.查看运行日志

   ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220422161953.png)

#### 业务测试

### 生产环境发布

项目编译，运行，测试都通过后方可发布程序

#### 项目打包

1. 先清除上次编译打包输出的内容

   ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220422162650.png)

2. 打包程序

   1.点击`install`进行打包，2.查看打包结果，3.最终各个模块输入完成的jar包

   ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220422162859.png)

#### 上传jar包

把jar包上传到服务器指定目录:`/home/pcqms/webapp/pcqms-service`

#### 启动程序

```
cd /home/pcqms/webapp/pcqms-service
nohup java -jar ss-eureka-server.jar &
nohup java -jar ss-config-server.jar &
nohup java -jar ss-business.jar &
nohup java -jar ss-jobtask.jar --spring.profiles.active=prod  &
```

> 注意：
>
> 1. 修改配置中心的redis端口号  -> 6389
>
> 2. 修改数据库的连接串 -> 192.168.203.21:3306
> 3. 验证进程 curl -l http://localhost:8033/pcqms-service/doc.html

## 前台系统

### 本地开发测试

#### 开发工具

1. 集成开发工具vscode

   - 官网 https://code.visualstudio.com/
   - 点击下载安装

2. web服务nodejs

   - 官网 http://nodejs.cn/download/ 

   - 安装

     ```shell
     brew install nodejs 
     brew install npm
     ```

   - 验证

     ```
     node -v 
     npm -v
     ```

#### 运行环境

1. web服务tomcat(暂时不用)

   - tomcat 官网 https://tomcat.apache.org/download-90.cgi

   - 下载安装tomcat

     ```shell
     wget --no-check-certificat https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.62/bin/apache-tomcat-9.0.62.tar.gz
     tar -xvf apache-tomcat-9.0.62.tar.gz
     mv apache-tomcat-9.0.62 tomcat
     ```

   - 修改服务端口，8080 --> 8099

     ```shell
     cd /home/pcqms/tomcat/conf
     #vi server.xml
         <Connector port="8080" protocol="HTTP/1.1"
                    connectionTimeout="20000"
                    redirectPort="8443" />
     ```

   - 启动服务

     ```shell
     cd /home/pcqms/tomcat/bin
     sh startup.sh
     ```

   - 停止服务

     ```
     cd /home/pcqms/tomcat/bin
     sh shutdown.sh
     ```

   - 访问web服务

     ```html
     curl -l http://192.168.203.20:8099/
     curl -l http://219.159.152.72:28099/
     ```

2. web服务nginx

   - 依赖包

     ```shell
     yum -y install gcc
     yum install -y pcre pcre-devel
     yum install -y zlib zlib-devel
     yum install -y openssl openssl-devel
     ```

   - 下载

     ```shell
     wget http://nginx.org/download/nginx-1.9.9.tar.gz
     ```

   - 解压 

     ```
     tar -xvf nginx-1.9.9.tar.gz
     ```

   - 编译

     ```shell
     ./configure --prefix=/home/pcqms/nginx
     make
     make install
     
     ```

   - 修改端口配置 

     ```shell
     #vi /home/pcqms/nginx/conf/nginx.conf
     listen       8099;
     ```

   - 增加反向代理配置

     ```json
             location ^~ /asphalt-front/ {
                 index login.html index.html default.html;
                 try_files $uri $uri/ /asphalt-front/index.html;
                 alias  /home/pcqms/webapp/asphalt-front/;
             }
     
             location ^~ /pcqms-service/ {
                 proxy_pass http://localhost:8033;
                 proxy_set_header host $host:$server_port;
                 proxy_set_header X-Real_IP $remote_addr;
                 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
     
             }
     ```

   - 开机启动

     ```shell
     #vi /etc/systemd/system/nginx.service
     
     [Unit]
     Description=nginx service
     
     After=network.target 
     
     [Service] 
     
     Type=forking 
     
     ExecStart=/home/pcqms/nginx/sbin/nginx
     
     ExecReload=/home/pcqms/nginx/sbin/nginx -s reload
     
     ExecStop=/home/pcqms/nginx/sbin/nginx -s quit
     
     PrivateTmp=true 
     
     [Install] 
     
     WantedBy=multi-user.target
     ```

   - 启停服务

     ```shell
     systemctl start nginx.service　         # 启动服务
     systemctl stop nginx.service　          # 停止服务
     systemctl restart nginx.service　       # 重新启动服务
     systemctl list-units --type=service     # 查看所有已启动的服务
     systemctl status nginx.service          # 查看服务当前状态
     systemctl enable nginx.service          # 设置开机自启动
     systemctl disable nginx.service         # 停止开机自启动
     
     #当前用户手工启停
     cd /home/pcqms/nginx/sbin
     ./nginx
     ./nginx -s quit
     ./nginx -s reload
     ```

   - 验证web服务

     ```html
     curl -l http://192.168.203.20:8099/
     curl -l http://219.159.152.72:28099/
     ```

#### 编译运行

1. 代码获取

   ```
   git clone ssh://zhlw_irsh@129.28.168.236:10033/home/zhlw_irsh/pcqms-web.git
   #输入git账户密码
   ```

2. 安装依赖

   ```
   yarn
   ```

3. 运行

   ```
   yarn dev
   ```

   ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220422183807.png)

4. 登录验证

   ![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220422183907.png)

### 生产环境发布

#### 项目打包

```
yarn build
```

![](https://cdn.jsdelivr.net/gh/dong-jianbin/drawing-bed/mall/20220422184857.png)

#### 上传项目

把打包后的项目上传到服务器指定目录:`/home/pcqms/webapp/`

#### 运行程序

```shell
curl -l http://192.168.203.20:8099/asphalt-front/
#公网
curl -l http://219.159.152.72:28099/asphalt-front/
```

## 部署问题

1. 避免连接问题，两台主机都关闭了防火墙。如安全方面不符合，可以改成开放端口方式
2. 按照测试环境部署一致，前台程序直接部署到nginx中，负载和web服务都压到nginx上。必要时可优化
3. 前台程序调用业务微服务直接写死ip端口，对于业务微服务的最大访问端`前台`，实际上是单服务的。必要时可优化
4. mysql，redis，kafka。均为单点部署。如有要求都可改为分布式集群部署

